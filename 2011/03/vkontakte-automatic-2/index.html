<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2 | Ayrat Belyaev</title><meta name=keywords content="habr,php,vkontakte,github,development"><meta name=description content="Вторая часть статьи об автоматической трансляции новостей в ВКонтакте"><meta name=author content="Ayrat Belyaev"><link rel=canonical href=https://aybe.org/2011/03/vkontakte-automatic-2/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6133e054c3af07b39ba41b5d09b207d60fd550c8a1ca6cb5f4e8423fcbb9ef96.css integrity="sha256-YTPgVMOvB7ObpBtdCbIH1g/VUMihymy19OhCP8u575Y=" rel="preload stylesheet" as=style><link rel=preload href=/img/avatar-35.jpg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://aybe.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aybe.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aybe.org/favicon-32x32.png><link rel=apple-touch-icon href=https://aybe.org/apple-touch-icon.png><link rel=mask-icon href=https://aybe.org/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script defer crossorigin=anonymous src=/assets/js/comments.min.70dce0ef190a617cbc8c42892eb4d253d8f1f6e9ecef13bb9aedba8a84cb5278.js integrity="sha256-cNzg7xkKYXy8jEKJLrTSU9jx9uns7xO7mu26ioTLUng="></script><script src=https://www.google.com/recaptcha/api.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-MFD8PM59LW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MFD8PM59LW',{anonymize_ip:!1})}</script><meta property="og:title" content="Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2"><meta property="og:description" content="Вторая часть статьи об автоматической трансляции новостей в ВКонтакте"><meta property="og:type" content="article"><meta property="og:url" content="https://aybe.org/2011/03/vkontakte-automatic-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2011-03-17T11:16:04+03:00"><meta property="article:modified_time" content="2021-07-27T17:37:57+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2"><meta name=twitter:description content="Вторая часть статьи об автоматической трансляции новостей в ВКонтакте"><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Записи",
      "item": "https://aybe.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Сайты",
      "item": "https://aybe.org/posts/site/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2",
      "item": "https://aybe.org/2011/03/vkontakte-automatic-2/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2",
  "name": "Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2",
  "description": "Вторая часть статьи об автоматической трансляции новостей в ВКонтакте",
  "keywords": [
    "habr", "php", "vkontakte", "github", "development"
  ],
  "articleBody": " Это копия моей оригинальной статьи, опубликованной на Хабре в 2011 году. Опубликована как есть, без изменений текста, поправлены только ссылки.\n В первой части мы научились автоматически публиковать записи на нашу стенку, сегодня же добавим блекджек и шлюх возможность добавлять к ссылкам картинки автоматически. В этот раз я не буду приводить готовые php функции, так как они описаны в первой части, а сейчас лишь буду описывать нужные нам php-файлы и параметры, которые нужно передавать им.\nПосле первой части я получил большое количество сообщений, большая часть из которых посвящалась тому, что я продемонстрировал в статье возможность публикации на собственной стенке, а автоматическую публикацию на стене Группы или Официальной странице я не показал. Поэтому я начну с того, какие параметры нужно для этого передавать.\nОфициальная страница Вы должны входить в состав администраторов страницы для возможности публикации новостей. Рассмотрим нужны нам параметры, которые передаются al_wall.php при публикации простого сообщения:\nact = 'post', 'delete' al = 1 facebook_export = '' status_export = '' friends_only = '' hash = '' message = '' note_title = '' official = '' to_id = '' type = 'all' media = '' media_type = 'photo'  В параметре act мы передаем необходимо действие — либо 'post' для публикации сообщения, либо 'delete' для его удаления. Причем, при удалении необходимо так же передать параметр 'post', который содержит id страницы и порядковый номер сообщения на стенке, например, 11111_32; Параметры facebook_export и status_export служат для экспорта в сервисы Facebook и Twitter, если таковые прилинкованы к странице; Параметр hash нам уже знаком, его можно найти при открытии страницы или группы в блоке с параметрами под названием post_hash; Стоит заметить, что параметр note_title опускается, то есть заметки создано не будет, вместо этого вашу запись обрежут, если она превысит допустимый размер; В to_id стоит передавать ваш id Официальной страницы или группы со знаком минус впереди, например, '-11111'; Осталось рассмотретьmedia и media_type, в первом следует передавать внутреннюю ссылку на нужный объект, а во втором его тип. Например, media = '1111_1213232213', media_type = 'photo'. В данном случае к записи будет прикреплена указанная фотография. Тип так же может быть 'audio', 'video'. Если передать тип 'share', а в 'media' указатель на фото, то в сообщении-ссылке данная фотка будет в подсказке. Только нужно не забыть добавить еще три известных нам параметра для ссылки — url, title и description. Увы, но пока я не нашел способа публиковать сообщение-фото совместно с сообщением-ссылкой как это сделано на страничке Хабрахабр ВКонтакте.  Загрузка фотографии На самом деле при загрузке картинки главное не забывать о прокси, а дальше все достаточно просто. Итак, чтобы загрузить картинку мы воспользуемся файлом share.php, который предназначен для публикации внешних ссылок. Вот пример POST параметров, которые необходимо на него передать:\nact = a_photo url = image = extra = В параметре url передаете вашу ссылку, в параметре image — ссылку на нужную картинку, а парамерт extra можно проигнорировать. Отмечу, что если вы используете CURL, как я в прошлой части, то не забудьте следующее:\ncurl_setopt($ch, CURLOPT_REFERER, 'http://vkontakte.ru/share.php'); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); Второй параметр нам нужен, так как после отправки POST запроса, share.php перенаправит запрос (путем возврата 302 ошибки и передачи параметра Location) на upload.php с нужным сервером и необходимыми параметрами, рассматривать которые, я думаю, не имеет смысла. В свою очередь upload.php перенаправит запрос на complete.php, который, в зависимости от успеха, выдаст либо ошибку, либо нужный нам результат.\nВариант с ошибкой:\nscript type=\"text/javascript\" document.domain = location.host.toString().match(/[a-zA-Z]*\\.[a-zA-Z]*$/)[0]; parent.onUploadFail(0, 'Неизвестная ошибка'); /script Это значит, что скорее всего ваша ссылка на картинку неверна или невалидна. Вариант, который нам нужен выглядит так:\nscript type=\"text/javascript\" document.domain = location.host.toString().match(/[a-zA-Z]*\\.[a-zA-Z]*$/)[0]; parent.onUploadDone(0, {\"user_id\":1234567,\"photo_id\":235889241}); /script Вот он, тот самый photo_id, который нужно передавать при размещении фотографии на стенке, в данном случае полный составной id: 1234567_235889241. Просто, неправда ли?\nЧтобы получить прямой путь к загруженной фотке необходимо послать запрос к al_photo.php, с работой которого я пока до конца не разобрался, в частности пока не ясно какой именно hash он требует для проверки запроса. Если кто-то разберется — сообщите:).\nСтоит заметить, что можно разместить ссылку с картинкой в подсказке не только через al_wall.php как я описал выше, но и через share.php, для этого нужно снова послать запрос к share.php с большим количеством параметров. Поставлю коментарии, там где могут возникнуть трудности:\nact: 'a_submit' // метод hash: shareHash // параметр функции onDomReady, который можно найти на странице share.php при открытии, полное название window.shareHash title: // наименование заметки url: // ссылка share_title: // название статуса share_text: // описание статуса share_comment: // ваш комментарий image_url: // ссылка на картинку, если загрузка картинки вернула onUploadFail photo_owner_id: // id загрузившего фото photo_id: // id, полученный нами выше privacy_note: 0 // можно просто поставить 0 privacy_notecomm: 0 // можно просто поставить 0 to_status: 1 // 1, если публикуем статус status_export: // экспорт статуса в твиттер to_note: // пусто, если публикация в статус и 1, если в заметку  Вообще через share.php можно публиковать видео и аудио, загружать их на сервер через параметры extra и extra_data, однако я не вижу в этом острой необходимости.\nДумаю, что пока этого более чем достаточно, когда найду способ совмещения в одном сообщении ссылки и фото, то напишу каким образом это можно сделать. Или буду надеяться, что они откроют такую функциональность для Групп и Официальных страничек. Замечу только, что если загружать фотку через интерфейс ВКонтакте на Официальной странице, то photo_id будет присвоен вида [-id страницы]_[номер_фото], а при просмотре фотки Автором будет ваша страница или группа.\nТакого эффекта можно добиться и через скрипт, если передавать параметры не на share.php, а напрямую на upload.php, но в этом случае нам нужно знать еще кучу параметров, в том числе два разных hash-параметра, поэтому этот способ я рассматривать не стал.\nОтдельная просьба задавать вопросы по теме в комментариях, а не через личную почту, потому что большинство вопросов одинаковы и приходится объяснять одно и то же каждый раз :).\nUPD: По просьбам в комментариях набросал простенький класс и пример использования. Брать тут: github.com/xbreaker/vk.wallpost\n[Первая часть](https://aybe.org/2011/02/vkontakte-automatic-1/\n",
  "wordCount" : "956",
  "inLanguage": "ru",
  "datePublished": "2011-03-17T11:16:04+03:00",
  "dateModified": "2021-07-27T17:37:57+03:00",
  "author":{
    "@type": "Person",
    "name": "Ayrat Belyaev"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://aybe.org/2011/03/vkontakte-automatic-2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ayrat Belyaev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://aybe.org/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://aybe.org/ accesskey=h title="Ayrat Belyaev (Alt + H)"><img src=/img/avatar-35.jpg alt=logo aria-label=logo height=35>Ayrat Belyaev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://aybe.org/search title=поиск><span>поиск</span></a></li><li><a href=https://aybe.org/archives title=архив><span>архив</span></a></li><li><a href=https://aybe.org/tags title=теги><span>теги</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aybe.org/>Главная</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/>Записи</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/site/>Сайты</a></div><h1 class=post-title>Автоматическое оповещение читателей о новостях с помощью ВКонтакте. Часть 2</h1><div class=post-description>Вторая часть статьи об автоматической трансляции новостей в ВКонтакте</div><div class=post-meta>March 17, 2011&nbsp;·&nbsp;5 мин&nbsp;·&nbsp;Ayrat Belyaev</div></header><div class=post-content><blockquote><p>Это копия моей <a href=https://habr.com/ru/post/115658/>оригинальной статьи</a>, опубликованной на Хабре в 2011 году. Опубликована как есть, без изменений текста, поправлены только ссылки.</p></blockquote><p>В первой части мы научились автоматически публиковать записи на нашу стенку, сегодня же добавим <del>блекджек и шлюх</del> возможность добавлять к ссылкам картинки автоматически. В этот раз я не буду приводить готовые php функции, так как они описаны в первой части, а сейчас лишь буду описывать нужные нам php-файлы и параметры, которые нужно передавать им.</p><p>После первой части я получил большое количество сообщений, большая часть из которых посвящалась тому, что я продемонстрировал в статье возможность публикации на собственной стенке, а автоматическую публикацию на стене Группы или Официальной странице я не показал. Поэтому я начну с того, какие параметры нужно для этого передавать.</p><h4 id=официальная-страница>Официальная страница<a hidden class=anchor aria-hidden=true href=#официальная-страница>#</a></h4><p>Вы должны входить в состав администраторов страницы для возможности публикации новостей. Рассмотрим нужны нам параметры, которые передаются <code>al_wall.php</code> при публикации простого сообщения:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>act</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;post&#39;</span>, <span style=color:#e6db74>&#39;delete&#39;</span>
<span style=color:#a6e22e>al</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>facebook_export</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>status_export</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>friends_only</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>hash</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>message</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>note_title</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>official</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>to_id</span>   <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>type</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;all&#39;</span>
<span style=color:#a6e22e>media</span>   <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
<span style=color:#a6e22e>media_type</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;photo&#39;</span></code></pre></div><ul><li>В параметре <code>act</code> мы передаем необходимо действие &mdash; либо <code>'post'</code> для публикации сообщения, либо <code>'delete'</code> для его удаления. Причем, при удалении необходимо так же передать параметр <code>'post'</code>, который содержит <code>id</code> страницы и порядковый номер сообщения на стенке, например, <code>11111_32</code>;</li><li>Параметры <code>facebook_export</code> и <code>status_export</code> служат для экспорта в сервисы Facebook и Twitter, если таковые прилинкованы к странице;</li><li>Параметр <code>hash</code> нам уже знаком, его можно найти при открытии страницы или группы в блоке с параметрами под названием <code>post_hash</code>;</li><li>Стоит заметить, что параметр <code>note_title</code> опускается, то есть заметки создано не будет, вместо этого вашу запись обрежут, если она превысит допустимый размер;</li><li>В <code>to_id</code> стоит передавать ваш <code>id</code> Официальной страницы или группы со знаком минус впереди, например, <code>'-11111'</code>;</li><li>Осталось рассмотреть<code>media</code> и <code>media_type</code>, в первом следует передавать внутреннюю ссылку на нужный объект, а во втором его тип. Например, <code>media => '1111_1213232213'</code>, <code>media_type => 'photo'</code>. В данном случае к записи будет прикреплена указанная фотография. Тип так же может быть <code>'audio'</code>, <code>'video'</code>. Если передать тип <code>'share'</code>, а в <code>'media'</code> указатель на фото, то в сообщении-ссылке данная фотка будет в подсказке. Только нужно не забыть добавить еще три известных нам параметра для ссылки &mdash; <code>url</code>, <code>title</code> и<code> description</code>.
Увы, но пока я не нашел способа публиковать сообщение-фото совместно с сообщением-ссылкой как это сделано на страничке Хабрахабр ВКонтакте.</li></ul><h4 id=загрузка-фотографии>Загрузка фотографии<a hidden class=anchor aria-hidden=true href=#загрузка-фотографии>#</a></h4><p>На самом деле при загрузке картинки главное не забывать о прокси, а дальше все достаточно просто. Итак, чтобы загрузить картинку мы воспользуемся файлом <code>share.php</code>, который предназначен для публикации внешних ссылок. Вот пример POST параметров, которые необходимо на него передать:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>act</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>a_photo</span>
<span style=color:#a6e22e>url</span> <span style=color:#f92672>=&gt;</span>
<span style=color:#a6e22e>image</span> <span style=color:#f92672>=&gt;</span>
<span style=color:#a6e22e>extra</span> <span style=color:#f92672>=&gt;</span></code></pre></div><p>В параметре <code>url</code> передаете вашу ссылку, в параметре image &mdash; ссылку на нужную картинку, а парамерт <code>extra</code> можно проигнорировать. Отмечу, что если вы используете CURL, как я в прошлой части, то не забудьте следующее:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>curl_setopt</span>($ch, <span style=color:#a6e22e>CURLOPT_REFERER</span>, <span style=color:#e6db74>&#39;http://vkontakte.ru/share.php&#39;</span>);
<span style=color:#a6e22e>curl_setopt</span>($ch, <span style=color:#a6e22e>CURLOPT_FOLLOWLOCATION</span>, <span style=color:#ae81ff>1</span>);</code></pre></div><p>Второй параметр нам нужен, так как после отправки POST запроса, share.php перенаправит запрос (путем возврата 302 ошибки и передачи параметра Location) на <code>upload.php</code> с нужным сервером и необходимыми параметрами, рассматривать которые, я думаю, не имеет смысла. В свою очередь <code>upload.php</code> перенаправит запрос на <code>complete.php</code>, который, в зависимости от успеха, выдаст либо ошибку, либо нужный нам результат.</p><p>Вариант с ошибкой:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/javascript&#34;</span><span style=color:#f92672>&gt;</span>
document.<span style=color:#a6e22e>domain</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>host</span>.<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/[a-zA-Z]*\.[a-zA-Z]*$/</span>)[<span style=color:#ae81ff>0</span>];
<span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>onUploadFail</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;Неизвестная ошибка&#39;</span>);
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/script&gt;</span></code></pre></div><p>Это значит, что скорее всего ваша ссылка на картинку неверна или невалидна. Вариант, который нам нужен выглядит так:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/javascript&#34;</span><span style=color:#f92672>&gt;</span>
document.<span style=color:#a6e22e>domain</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>host</span>.<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/[a-zA-Z]*\.[a-zA-Z]*$/</span>)[<span style=color:#ae81ff>0</span>];
<span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>onUploadDone</span>(<span style=color:#ae81ff>0</span>, {<span style=color:#e6db74>&#34;user_id&#34;</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1234567</span>,<span style=color:#e6db74>&#34;photo_id&#34;</span><span style=color:#f92672>:</span><span style=color:#ae81ff>235889241</span>});
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/script&gt;</span></code></pre></div><p>Вот он, тот самый <code>photo_id</code>, который нужно передавать при размещении фотографии на стенке, в данном случае полный составной id: <code>1234567_235889241</code>. Просто, неправда ли?</p><p>Чтобы получить прямой путь к загруженной фотке необходимо послать запрос к <code>al_photo.php</code>, с работой которого я пока до конца не разобрался, в частности пока не ясно какой именно hash он требует для проверки запроса. Если кто-то разберется &mdash; сообщите:).</p><p>Стоит заметить, что можно разместить ссылку с картинкой в подсказке не только через <code>al_wall.php</code> как я описал выше, но и через share.php, для этого нужно снова послать запрос к share.php с большим количеством параметров. Поставлю коментарии, там где могут возникнуть трудности:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>act</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;a_submit&#39;</span>     <span style=color:#75715e>// метод
</span><span style=color:#75715e></span><span style=color:#a6e22e>hash</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>shareHash</span>     <span style=color:#75715e>// параметр функции onDomReady, который можно найти на странице share.php при открытии, полное название window.shareHash
</span><span style=color:#75715e></span><span style=color:#a6e22e>title</span><span style=color:#f92672>:</span>              <span style=color:#75715e>// наименование заметки
</span><span style=color:#75715e></span><span style=color:#a6e22e>url</span><span style=color:#f92672>:</span>                <span style=color:#75715e>// ссылка
</span><span style=color:#75715e></span><span style=color:#a6e22e>share_title</span><span style=color:#f92672>:</span>        <span style=color:#75715e>// название статуса
</span><span style=color:#75715e></span><span style=color:#a6e22e>share_text</span><span style=color:#f92672>:</span>         <span style=color:#75715e>// описание статуса
</span><span style=color:#75715e></span><span style=color:#a6e22e>share_comment</span><span style=color:#f92672>:</span>      <span style=color:#75715e>// ваш комментарий
</span><span style=color:#75715e></span><span style=color:#a6e22e>image_url</span><span style=color:#f92672>:</span>          <span style=color:#75715e>// ссылка на картинку, если загрузка картинки вернула onUploadFail
</span><span style=color:#75715e></span><span style=color:#a6e22e>photo_owner_id</span><span style=color:#f92672>:</span>     <span style=color:#75715e>// id загрузившего фото
</span><span style=color:#75715e></span><span style=color:#a6e22e>photo_id</span><span style=color:#f92672>:</span>           <span style=color:#75715e>// id, полученный нами выше
</span><span style=color:#75715e></span><span style=color:#a6e22e>privacy_note</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>     <span style=color:#75715e>// можно просто поставить 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>privacy_notecomm</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e>// можно просто поставить 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>to_status</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>        <span style=color:#75715e>// 1, если публикуем статус
</span><span style=color:#75715e></span><span style=color:#a6e22e>status_export</span><span style=color:#f92672>:</span>      <span style=color:#75715e>// экспорт статуса в твиттер
</span><span style=color:#75715e></span><span style=color:#a6e22e>to_note</span><span style=color:#f92672>:</span>            <span style=color:#75715e>// пусто, если публикация в статус и 1, если в заметку
</span></code></pre></div><p>Вообще через <code>share.php</code> можно публиковать видео и аудио, загружать их на сервер через параметры <code>extra</code> и <code>extra_data</code>, однако я не вижу в этом острой необходимости.</p><p>Думаю, что пока этого более чем достаточно, когда найду способ совмещения в одном сообщении ссылки и фото, то напишу каким образом это можно сделать. Или буду надеяться, что они откроют такую функциональность для Групп и Официальных страничек. Замечу только, что если загружать фотку через интерфейс ВКонтакте на Официальной странице, то <code>photo_id</code> будет присвоен вида <code>[-id страницы]_[номер_фото]</code>, а при просмотре фотки Автором будет ваша страница или группа.</p><p>Такого эффекта можно добиться и через скрипт, если передавать параметры не на <code>share.php</code>, а напрямую на <code>upload.php</code>, но в этом случае нам нужно знать еще кучу параметров, в том числе два разных hash-параметра, поэтому этот способ я рассматривать не стал.</p><p>Отдельная просьба задавать вопросы по теме в комментариях, а не через личную почту, потому что большинство вопросов одинаковы и приходится объяснять одно и то же каждый раз :).</p><p><strong>UPD</strong>: По просьбам в комментариях набросал простенький класс и пример использования.
Брать тут: <a href=https://github.com/xbreaker/vk.wallpost>github.com/xbreaker/vk.wallpost</a></p><p>[Первая часть](https://aybe.org/2011/02/vkontakte-automatic-1/</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://aybe.org/tags/habr/>habr</a></li><li><a href=https://aybe.org/tags/php/>php</a></li><li><a href=https://aybe.org/tags/vkontakte/>vkontakte</a></li><li><a href=https://aybe.org/tags/github/>github</a></li><li><a href=https://aybe.org/tags/development/>development</a></li></ul><nav class=paginav><a class=prev href=https://aybe.org/2012/08/hybriauth-integration/><span class=title>« Предыдущая</span><br><span>HybridAuth — интеграция сайта с социальными сетями</span></a>
<a class=next href=https://aybe.org/2011/02/vkontakte-automatic-1/><span class=title>Следующая »</span><br><span>Автоматическое оповещение читателей о новостях с помощью ВКонтакте</span></a></nav></footer><section id=comment-thread class="js-comments comment-thread"><form id=reply-form class="js-form reply-form" method=post action=https://aybeorg.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments><h3 id=reply-form-head>Добавить комментарий</h3><div id=notice class=notice></div><input type=hidden name=options[slug] value=vkontakte-automatic-2>
<input type=hidden name=options[parent] value=https://aybe.org/2011/03/vkontakte-automatic-2/>
<input id=input-thread type=hidden name=fields[thread]>
<input id=input-parent type=hidden name=fields[parent]>
<input id=input-parentName type=hidden name=fields[parentName]>
<input type=hidden name=options[reCaptcha][siteKey] value=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ>
<input type=hidden name=options[reCaptcha][secret] value="w0e8kjpH56nyKZkvYX0Oe4kOTSOxu3c1rr2Cw4L67iB0Gx1MTBSemXn0pY+05X3Lezu/FEORlYMB15Mr9lZHSDhdpkee2l3dw3SMD7BAkJpAErtXqyC5PsSinCsZf0989VObxa/74QAp+NyF7Zr4lbY+equDeBPN9p/TqwSv0jn5Wdj2xJOoCfdThiAEeN+6DRXIqnnIMWZ6PPVkiYuBQb8zYvywNgaJ18ctucTKlnOI3SsVR8G4R86jtkvn/+cl9u+2Tu61yS1HPwz78/Aips9OdRFcLdsConD6QqbJV4R0lKFArqjD7smPKal3z/WqH1P4gED54NuNSI6VQt+Tu0J25qgEmZuL+3tJp+Jr1WyGCjrHdvatxa/dTDQgV2F+XLSLd/RmC9GbT3ukEB1CI/IFvznuj4iHtBNog7v7mwht4CVUGzIsaHNSkzMdjP/Tbt8K7YptjkhyUISuamDwbauXiTUlQishzwP8l3iM0CJRh3gKQGBP9u5svoctjCgzQzjgHfqHDgnKD2oyzSl4l4/UmwetxCEkvmY9h05VinAqMKu+wg1TTpKh0xJ0LW7TGoctfoupnzM+XTUy0UGxHBNdVFDVoP9xoQcZgkfw2yWm96t3K78kRMqWbiNqw0ZuJPy6x1IFeuPLh9CLhwflfkJW1j8UbG+WHzQLgJJUIkQ=">
<textarea name=fields[message] placeholder="Вы можете использовать синтаксис Markdown" rows=6 required></textarea>
<input name=fields[name] type=text placeholder=имя required>
<input type=email name=fields[email] placeholder=email required><div class=g-recaptcha data-sitekey=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ></div><button id=submit>Отправить</button>
<button id=cancel-button class=d-none data-toggle=reply-form-cancel>Отменить</button></form></section></article></main><footer class=footer><span>&copy; 2021 <a href=https://aybe.org/>Ayrat Belyaev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>