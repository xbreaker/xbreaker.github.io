<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine | Ayrat Belyaev</title><meta name=keywords content="udm,udm pro,ubiquiti,dyndns,inadyn"><meta name=description content="После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.
Поэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS?"><meta name=author content="Ayrat Belyaev"><link rel=canonical href=https://aybe.org/2021/06/custom-dyndns-for-udm/><link crossorigin=anonymous href=/assets/css/stylesheet.min.eb7a119567ea1d2fc28f00b284062dba30442366caa980d940836847204b99da.css integrity="sha256-63oRlWfqHS/CjwCyhAYtujBEI2bKqYDZQINoRyBLmdo=" rel="preload stylesheet" as=style><link rel=preload href=/img/avatar-35.jpg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://aybe.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aybe.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aybe.org/favicon-32x32.png><link rel=apple-touch-icon href=https://aybe.org/apple-touch-icon.png><link rel=mask-icon href=https://aybe.org/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script defer crossorigin=anonymous src=/assets/js/comments.min.70dce0ef190a617cbc8c42892eb4d253d8f1f6e9ecef13bb9aedba8a84cb5278.js integrity="sha256-cNzg7xkKYXy8jEKJLrTSU9jx9uns7xO7mu26ioTLUng="></script><script src=https://www.google.com/recaptcha/api.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-MFD8PM59LW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MFD8PM59LW',{anonymize_ip:!1})}</script><meta property="og:title" content="Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine"><meta property="og:description" content="После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.
Поэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS?"><meta property="og:type" content="article"><meta property="og:url" content="https://aybe.org/2021/06/custom-dyndns-for-udm/"><meta property="og:image" content="https://aybe.org/img/posts/dyndns_udm_0.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-08T17:46:06+03:00"><meta property="article:modified_time" content="2021-07-16T09:37:23+03:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aybe.org/img/posts/dyndns_udm_0.png"><meta name=twitter:title content="Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine"><meta name=twitter:description content="После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.
Поэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS?"><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Записи",
      "item": "https://aybe.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UDM",
      "item": "https://aybe.org/posts/udm/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine",
      "item": "https://aybe.org/2021/06/custom-dyndns-for-udm/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine",
  "name": "Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine",
  "description": "После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.\nПоэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS?",
  "keywords": [
    "udm", "udm pro", "ubiquiti", "dyndns", "inadyn"
  ],
  "articleBody": "После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.\nПоэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS? Какие настройки требуются для этого?\nПринцип работы Dynamic DNS на UDM Первым делом я решил проверить логи, для этого я выполнил настройки с левыми данными, чтобы появились ошибки:\n  Пробные настройки\n  Смотрим логи:\n# tail -20 /var/log/messages Jun 07 11:20:36 router user.notice inadyn[5437]: In-a-dyn version 2.5 -- Dynamic DNS update client. Jun 07 11:20:36 router user.warn inadyn[5437]: Guessing DDNS plugin 'default@freedns.afraid.org' from 'afraid' Jun 07 11:20:36 router user.notice inadyn[5437]: Update forced for alias test.test.com, new IP# 1.1.1.1 Jun 07 11:20:43 router user.warn inadyn[5437]: HTTP(S) Transaction failed, error 36: Temporary network error (HTTPS send) По логам видно, что для обновления IP используется Internet Automated Dynamic DNS Client (Inadyn) - библиотека с открытым исходным кодом!\nДанная библиотека обладает превосходной документацией, а так же поддерживает намного больше провайдеров Dynamic DNS, чем доступно в UnifiOS. Однако, в моем случае нужного мне провайдера не оказалось в списке, а значит придется искать другой путь. К счастью, Inadyn поддерживает кастомные настройки, то есть можно параметризировать любое доступное API и Inadyn сможет с ним взаимодействовать.\nОсталось выяснить какие параметры нам нужны, для этого можно поискать описание стандартных сервисов, например, такое есть у Oracle и его сервиса dyn.com. Согласно ей нам необходимо формировать запросы вида:\nGET /nic/update?hostname=home.dyn.com\u0026myip=192.168.0.1 HTTP/1.0 Host: ddns.dyn.com Authorization: Basic AuthBase64 А в ответ получать:\nHTTP/1.0 200 OK Content-Length: 4 Content-Type: text/plain good Осталось собрать простое приложение, которое будет принимать указанные запросы и отвечать в заданном формате, я собрал его на NodeJS и запустил на Heroku:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  var express = require('express'); var app = express(); var ip = function( req, res ) { if (req.headers['authorization']) { auth = new Buffer(req.headers['authorization'].substring(6), 'base64').toString().split(':'); if (auth \u0026\u0026 auth[0] === process.env.BASIC_AUTH_LOGIN \u0026\u0026 auth[1] === process.env.BASIC_AUTH_PASS ) { console.log( 'Auth:', auth ); if( typeof res =='function' ) { res(null, \"good\") } else { res.send(\"good\"); } } } if(req.headers['user-agent']) { console.log( 'User-Agent:', req.headers['user-agent'] ); } } app.get('nic/update?hostname=:name\u0026myip=:ip', ip); app.get('/', function (req, res) { res.send('bad'); }); app.listen(process.env.PORT || 3000) console.log('Listening on port 3000...');   После этого попробовал настроить UDM на запросы к моему серверу, в поле Server вписал адрес приложения Heroku:\n  Попытка номер 2\n  После этого запустил просмотр логов приложения и к нему не было ни одного обращения. Пришлось вернуться в UDM и посмотреть логи там:\nJun 07 12:46:32 Home user.warn inadyn[18541]: Fatal error in DDNS server response: Jun 07 12:46:32 Home user.warn inadyn[18541]: [400 Bad Request] 400 Bad Request Jun 07 12:46:32 Home user.warn inadyn[18541]: Error response from DDNS server, ignoring ... Да уж, краткость - сестра таланта. Плюс Inadyn запускается только при смене IP адреса, а для отладки нужна возможность ручного запуска, еще желательно иметь более подробные логи. По документации можно заставить Inadyn писать подробные логи на экран, только нужно правильно указать файл конфигурации - на UDM он расположен по пути /run/inadyn.conf, а полностью команда запуска будет выглядеть:\n# /usr/sbin/inadyn -n -s -C -f /run/inadyn.conf -1 -l debug --foreground Результат запроса к моему серверу:\nGET test.test.com HTTP/1.0 Host: app.myherokuapp.com Authorization: Basic rFrt............................A== User-Agent: inadyn/2.5 https://github.com/troglobit/inadyn/issues Здесь явно чего-то не хватает - UDM запрашивает лишь hostname напрямую, без всяких параметров. Посмотрим, что содержится в файле конфига /run/inadyn.comf:\n# # Generated automatically by ubios-udapi-server # iface = eth8 custom app.myherokuapp.com { hostname = \"test.test.com\" username = \"test\" password = \"test\" ddns-server = \"app.myherokuapp.com\" } Судя по форумам нам не хватает дополнительной строки параметров ddns-path. Поискав по форумам, я нашел, что в поле Server кроме домена можно так же передавать и параметры, тогда появится и наша дополнительная строка. Более того, оказалось, что каждый раз, когда заполняется строка Server, то Inadyn воспринимает всю конфигурацию как кастомную, и не важно какой провайдер был выбран выше, он будет проигнорирован. Добавив новые значения в поле Server мы получим и нашу новую строку:\nddns-path = \"/nic/update?hostname=%h\u0026myip=%i\" Без этой строки, по конфигурации выше, наш запрос выглядел вот так app.myherokuapp.com/test.test.com. Смотрим документацию - там есть описание параметров:\n%u - username, if HTTP basic auth is not used %p - password, if HTTP basic auth is not used %h - hostname %i - current IP address Прекрасно, пробуем заполнить строку Server с указанием параметров, то есть app.myherokuapp.com/nic/update?hostname=%h\u0026myip=%i, получаем конфиг:\n# # Generated automatically by ubios-udapi-server # iface = eth8 custom app.myherokuapp.com { hostname = \"test.test.com\" username = \"test\" password = \"test\" ddns-server = \"app.myherokuapp.com\" ddns-path = \"/nic/update?hostname=%h\u0026myip=%i\" } Запустил вручную Inadyn и все отработало как надо, мое приложение вернуло good, однако при запуске после сохранения настроек и переход на автоматический запуск через UDM - ничего не работает, причина:\nGET nic/update?hostname=test.test.com\u0026myip=192.168.0.1test.test.com HTTP/1.0 Host: app.myherokuapp.com Authorization: Basic rFrt............................A== User-Agent: inadyn/2.5 https://github.com/troglobit/inadyn/issues Причина в приклеенном к запросу адресом хоста, решение этой проблемы заняло не мало времени и ответ был найден на официальном форуме. В адресе параметров необходимо добавить обратный слэш после домена и тогда адрес хоста не будет приклеиваться в конец запроса:\nddns-path = \"\\/nic/update?hostname=%h\u0026myip=%i\" И наш итоговый конфиг:\n  Итоговый конфиг\n  Проверим результат в логах:\n# cat /var/log/messages | grep inadyn Jun 07 18:12:03 router user.notice inadyn[13088]: In-a-dyn version 2.5 -- Dynamic DNS update client. Jun 07 18:12:03 router user.notice inadyn[13088]: Update forced for alias test.test.com, new IP# 1.2.3.4 Jun 07 18:12:04 router user.notice inadyn[13088]: Updating cache for test.test.com Итого:\n Заполнение поля Server в настройках включает игнор провайдера выбранного из списка и позволяет кастомно настраивать Dynamic DNS; В поле Server нужно вписывать адрес без https, ее Inadyn добавит самостоятельно (выполнять запросы к HTTP не получится); Inadyn кэширует удачные запросы и сохраняет IP, если он был обновлен - достаточно удалить /.inadyn, если запуск происходит по настройкам. Если запускаете вручную командой, то кэш будет расположен по пути /root/.inadyn;  ",
  "wordCount" : "1004",
  "inLanguage": "ru",
  "image":"https://aybe.org/img/posts/dyndns_udm_0.png","datePublished": "2021-06-08T17:46:06+03:00",
  "dateModified": "2021-07-16T09:37:23+03:00",
  "author":{
    "@type": "Person",
    "name": "Ayrat Belyaev"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://aybe.org/2021/06/custom-dyndns-for-udm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ayrat Belyaev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://aybe.org/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://aybe.org/ accesskey=h title="Ayrat Belyaev (Alt + H)"><img src=/img/avatar-35.jpg alt=logo aria-label=logo height=35>Ayrat Belyaev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://aybe.org/search title=поиск><span>поиск</span></a></li><li><a href=https://aybe.org/archives title=архив><span>архив</span></a></li><li><a href=https://aybe.org/tags title=теги><span>теги</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aybe.org/>Главная</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/>Записи</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/udm/>UDM</a></div><h1 class=post-title>Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine</h1><div class=post-meta>June 8, 2021&nbsp;·&nbsp;5 мин&nbsp;·&nbsp;Ayrat Belyaev</div></header><figure class=entry-cover><img loading=lazy src=https://aybe.org/img/posts/dyndns_udm_0.png alt></figure><div class=post-content><p>После перехода с FreshTomato на UnifiOS первым делом возникла необходимость переноса настроек Dynamic DNS. На UDM для настройки доступен лишь небольшой список предустановленных провайдеров dynamic dns, требующих оплату за свою работу. Такой вариант меня не устраивал поэтому было решено посмотреть как это устроено внутри и есть ли вариант использовать своего провайдера.</p><p>Поэтому для начала разберемся каким образом это можно сделать и возможно ли вообще это сделать на Unifi Dream Machine. И позволяют ли другие провайдеры настраивать обновление dynamic DNS? Какие настройки требуются для этого?</p><h3 id=принцип-работы-dynamic-dns-на-udm>Принцип работы Dynamic DNS на UDM<a hidden class=anchor aria-hidden=true href=#принцип-работы-dynamic-dns-на-udm>#</a></h3><p>Первым делом я решил проверить логи, для этого я выполнил настройки с левыми данными, чтобы появились ошибки:</p><figure><img loading=lazy src=/img/posts/dyndns_udm_1.png alt="Пробные настройки"><figcaption><p>Пробные настройки</p></figcaption></figure><p>Смотрим логи:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># tail -20 /var/log/messages</span>
Jun <span style=color:#ae81ff>07</span> 11:20:36 router user.notice inadyn<span style=color:#f92672>[</span>5437<span style=color:#f92672>]</span>: In-a-dyn version 2.5 -- Dynamic DNS update client.
Jun <span style=color:#ae81ff>07</span> 11:20:36 router user.warn inadyn<span style=color:#f92672>[</span>5437<span style=color:#f92672>]</span>: Guessing DDNS plugin <span style=color:#e6db74>&#39;default@freedns.afraid.org&#39;</span> from <span style=color:#e6db74>&#39;afraid&#39;</span>
Jun <span style=color:#ae81ff>07</span> 11:20:36 router user.notice inadyn<span style=color:#f92672>[</span>5437<span style=color:#f92672>]</span>: Update forced <span style=color:#66d9ef>for</span> alias test.test.com, new IP# 1.1.1.1
Jun <span style=color:#ae81ff>07</span> 11:20:43 router user.warn inadyn<span style=color:#f92672>[</span>5437<span style=color:#f92672>]</span>: HTTP<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span> Transaction failed, error 36: Temporary network error <span style=color:#f92672>(</span>HTTPS send<span style=color:#f92672>)</span></code></pre></div><p>По логам видно, что для обновления IP используется <a href=https://github.com/troglobit/inadyn>Internet Automated Dynamic DNS Client</a> (Inadyn) - библиотека с открытым исходным кодом!</p><p>Данная библиотека обладает превосходной документацией, а так же поддерживает намного больше провайдеров Dynamic DNS, чем доступно в UnifiOS. Однако, в моем случае нужного мне провайдера не оказалось в списке, а значит придется искать другой путь. К счастью, Inadyn поддерживает кастомные настройки, то есть можно параметризировать любое доступное API и Inadyn сможет с ним взаимодействовать.</p><p>Осталось выяснить какие параметры нам нужны, для этого можно поискать описание стандартных сервисов, например, такое есть у Oracle и его сервиса dyn.com. <a href=https://help.dyn.com/remote-access-api/perform-update/>Согласно ей</a> нам необходимо формировать запросы вида:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>GET /nic/update?hostname<span style=color:#f92672>=</span>home.dyn.com&amp;myip<span style=color:#f92672>=</span>192.168.0.1 HTTP/1.0
Host: ddns.dyn.com
Authorization: Basic AuthBase64</code></pre></div><p>А в ответ получать:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>HTTP/1.0 <span style=color:#ae81ff>200</span> OK
Content-Length: <span style=color:#ae81ff>4</span>
Content-Type: text/plain
good</code></pre></div><p>Осталось собрать простое приложение, которое будет принимать указанные запросы и отвечать в заданном формате, я собрал его на NodeJS и запустил на Heroku:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ip</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>( <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span> ) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;authorization&#39;</span>]) {
        <span style=color:#a6e22e>auth</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Buffer</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;authorization&#39;</span>].<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>6</span>), <span style=color:#e6db74>&#39;base64&#39;</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;:&#39;</span>);

        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>auth</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>auth</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>===</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BASIC_AUTH_LOGIN</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>auth</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>===</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BASIC_AUTH_PASS</span> ) {
            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>( <span style=color:#e6db74>&#39;Auth:&#39;</span>, <span style=color:#a6e22e>auth</span> );
            <span style=color:#66d9ef>if</span>( <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>==</span><span style=color:#e6db74>&#39;function&#39;</span> ) {
                <span style=color:#a6e22e>res</span>(<span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#34;good&#34;</span>)
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;good&#34;</span>);
            }
        }
    }
    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;user-agent&#39;</span>]) {
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>( <span style=color:#e6db74>&#39;User-Agent:&#39;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;user-agent&#39;</span>] );
    }
}

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;nic/update?hostname=:name&amp;myip=:ip&#39;</span>, <span style=color:#a6e22e>ip</span>);
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;bad&#39;</span>);
});

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>3000</span>)
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Listening on port 3000...&#39;</span>);</code></pre></td></tr></table></div></div><p>После этого попробовал настроить UDM на запросы к моему серверу, в поле Server вписал адрес приложения Heroku:</p><figure><img loading=lazy src=/img/posts/dyndns_udm_2.png alt="Попытка номер 2"><figcaption><p>Попытка номер 2</p></figcaption></figure><p>После этого запустил просмотр логов приложения и к нему не было ни одного обращения. Пришлось вернуться в UDM и посмотреть логи там:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Jun <span style=color:#ae81ff>07</span> 12:46:32 Home user.warn inadyn<span style=color:#f92672>[</span>18541<span style=color:#f92672>]</span>: Fatal error in DDNS server response:
Jun <span style=color:#ae81ff>07</span> 12:46:32 Home user.warn inadyn<span style=color:#f92672>[</span>18541<span style=color:#f92672>]</span>: <span style=color:#f92672>[</span><span style=color:#ae81ff>400</span> Bad Request<span style=color:#f92672>]</span> <span style=color:#ae81ff>400</span> Bad Request
Jun <span style=color:#ae81ff>07</span> 12:46:32 Home user.warn inadyn<span style=color:#f92672>[</span>18541<span style=color:#f92672>]</span>: Error response from DDNS server, ignoring ...</code></pre></div><p>Да уж, краткость - сестра таланта. Плюс Inadyn запускается только при смене IP адреса, а для отладки нужна возможность ручного запуска, еще желательно иметь более подробные логи. По документации можно заставить Inadyn писать подробные логи на экран, только нужно правильно указать файл конфигурации - на UDM он расположен по пути <code>/run/inadyn.conf</code>, а полностью команда запуска будет выглядеть:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># /usr/sbin/inadyn -n -s -C -f /run/inadyn.conf -1 -l debug --foreground</span></code></pre></div><p>Результат запроса к моему серверу:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>GET test.test.com HTTP/1.0
Host: app.myherokuapp.com
Authorization: Basic rFrt............................A<span style=color:#f92672>==</span>
User-Agent: inadyn/2.5 https://github.com/troglobit/inadyn/issues</code></pre></div><p>Здесь явно чего-то не хватает - UDM запрашивает лишь hostname напрямую, без всяких параметров. Посмотрим, что содержится в файле конфига <code>/run/inadyn.comf</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#</span>
<span style=color:#75715e># Generated automatically by ubios-udapi-server</span>
<span style=color:#75715e>#</span>
iface <span style=color:#f92672>=</span> eth8
custom app.myherokuapp.com <span style=color:#f92672>{</span>
    hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test.test.com&#34;</span>
    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
    ddns-server <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;app.myherokuapp.com&#34;</span>
<span style=color:#f92672>}</span></code></pre></div><p>Судя по форумам нам не хватает дополнительной строки параметров <code>ddns-path</code>. Поискав по форумам, я нашел, что в поле Server кроме домена можно так же передавать и параметры, тогда появится и наша дополнительная строка. Более того, оказалось, что каждый раз, когда заполняется строка Server, то Inadyn воспринимает всю конфигурацию как кастомную, и не важно какой провайдер был выбран выше, он будет проигнорирован. Добавив новые значения в поле Server мы получим и нашу новую строку:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>	ddns-path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/nic/update?hostname=%h&amp;myip=%i&#34;</span></code></pre></div><p>Без этой строки, по конфигурации выше, наш запрос выглядел вот так <code>app.myherokuapp.com/test.test.com</code>. Смотрим документацию - там есть описание параметров:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>%u - username, <span style=color:#66d9ef>if</span> HTTP basic auth is not used
%p - password, <span style=color:#66d9ef>if</span> HTTP basic auth is not used
%h - hostname
%i - current IP address</code></pre></div><p>Прекрасно, пробуем заполнить строку Server с указанием параметров, то есть <code>app.myherokuapp.com/nic/update?hostname=%h&myip=%i</code>, получаем конфиг:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#</span>
<span style=color:#75715e># Generated automatically by ubios-udapi-server</span>
<span style=color:#75715e>#</span>
iface <span style=color:#f92672>=</span> eth8
custom app.myherokuapp.com <span style=color:#f92672>{</span>
    hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test.test.com&#34;</span>
    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
    ddns-server <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;app.myherokuapp.com&#34;</span>
	ddns-path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/nic/update?hostname=%h&amp;myip=%i&#34;</span>
<span style=color:#f92672>}</span></code></pre></div><p>Запустил вручную Inadyn и все отработало как надо, мое приложение вернуло good, однако при запуске после сохранения настроек и переход на автоматический запуск через UDM - ничего не работает, причина:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>GET nic/update?hostname<span style=color:#f92672>=</span>test.test.com&amp;myip<span style=color:#f92672>=</span>192.168.0.1test.test.com HTTP/1.0
Host: app.myherokuapp.com
Authorization: Basic rFrt............................A<span style=color:#f92672>==</span>
User-Agent: inadyn/2.5 https://github.com/troglobit/inadyn/issues</code></pre></div><p>Причина в приклеенном к запросу адресом хоста, решение этой проблемы заняло не мало времени и ответ был найден на <a href="https://community.ui.com/questions/UDM-DynDNS-Google-Domains/fe9ba35d-66c3-437d-8323-debe2af55879?page=1">официальном форуме</a>. В адресе параметров необходимо добавить обратный слэш после домена и тогда адрес хоста не будет приклеиваться в конец запроса:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ddns-path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;\/nic/update?hostname=%h&amp;myip=%i&#34;</span></code></pre></div><p>И наш итоговый конфиг:</p><figure><img loading=lazy src=/img/posts/dyndns_udm_3.png alt="Итоговый конфиг"><figcaption><p>Итоговый конфиг</p></figcaption></figure><p>Проверим результат в логах:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># cat /var/log/messages | grep inadyn</span>
Jun <span style=color:#ae81ff>07</span> 18:12:03 router user.notice inadyn<span style=color:#f92672>[</span>13088<span style=color:#f92672>]</span>: In-a-dyn version 2.5 -- Dynamic DNS update client.
Jun <span style=color:#ae81ff>07</span> 18:12:03 router user.notice inadyn<span style=color:#f92672>[</span>13088<span style=color:#f92672>]</span>: Update forced <span style=color:#66d9ef>for</span> alias test.test.com, new IP# 1.2.3.4
Jun <span style=color:#ae81ff>07</span> 18:12:04 router user.notice inadyn<span style=color:#f92672>[</span>13088<span style=color:#f92672>]</span>: Updating cache <span style=color:#66d9ef>for</span> test.test.com</code></pre></div><p>Итого:</p><ol><li>Заполнение поля Server в настройках включает игнор провайдера выбранного из списка и позволяет кастомно настраивать Dynamic DNS;</li><li>В поле Server нужно вписывать адрес без https, ее Inadyn добавит самостоятельно (выполнять запросы к HTTP не получится);</li><li>Inadyn кэширует удачные запросы и сохраняет IP, если он был обновлен - достаточно удалить <code>/.inadyn</code>, если запуск происходит по настройкам. Если запускаете вручную командой, то кэш будет расположен по пути <code>/root/.inadyn</code>;</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://aybe.org/tags/udm/>udm</a></li><li><a href=https://aybe.org/tags/udm-pro/>udm pro</a></li><li><a href=https://aybe.org/tags/ubiquiti/>ubiquiti</a></li><li><a href=https://aybe.org/tags/dyndns/>dyndns</a></li><li><a href=https://aybe.org/tags/inadyn/>inadyn</a></li></ul><nav class=paginav><a class=prev href=https://aybe.org/2021/07/staticman-comments-for-github-pages/><span class=title>« Предыдущая</span><br><span>Добавление Staticman комментариев на статичные сайты (github-pages)</span></a></nav></footer><section id=comment-thread class="js-comments comment-thread"><form id=reply-form class="js-form reply-form" method=post action=https://aybeorg.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments><h3 id=reply-form-head>Добавить комментарий</h3><div id=notice class=notice></div><input type=hidden name=options[slug] value=custom-dyndns-for-udm>
<input type=hidden name=options[parent] value=https://aybe.org/2021/06/custom-dyndns-for-udm/>
<input id=input-thread type=hidden name=fields[thread]>
<input id=input-parent type=hidden name=fields[parent]>
<input id=input-parentName type=hidden name=fields[parentName]>
<input type=hidden name=options[reCaptcha][siteKey] value=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ>
<input type=hidden name=options[reCaptcha][secret] value="w0e8kjpH56nyKZkvYX0Oe4kOTSOxu3c1rr2Cw4L67iB0Gx1MTBSemXn0pY+05X3Lezu/FEORlYMB15Mr9lZHSDhdpkee2l3dw3SMD7BAkJpAErtXqyC5PsSinCsZf0989VObxa/74QAp+NyF7Zr4lbY+equDeBPN9p/TqwSv0jn5Wdj2xJOoCfdThiAEeN+6DRXIqnnIMWZ6PPVkiYuBQb8zYvywNgaJ18ctucTKlnOI3SsVR8G4R86jtkvn/+cl9u+2Tu61yS1HPwz78/Aips9OdRFcLdsConD6QqbJV4R0lKFArqjD7smPKal3z/WqH1P4gED54NuNSI6VQt+Tu0J25qgEmZuL+3tJp+Jr1WyGCjrHdvatxa/dTDQgV2F+XLSLd/RmC9GbT3ukEB1CI/IFvznuj4iHtBNog7v7mwht4CVUGzIsaHNSkzMdjP/Tbt8K7YptjkhyUISuamDwbauXiTUlQishzwP8l3iM0CJRh3gKQGBP9u5svoctjCgzQzjgHfqHDgnKD2oyzSl4l4/UmwetxCEkvmY9h05VinAqMKu+wg1TTpKh0xJ0LW7TGoctfoupnzM+XTUy0UGxHBNdVFDVoP9xoQcZgkfw2yWm96t3K78kRMqWbiNqw0ZuJPy6x1IFeuPLh9CLhwflfkJW1j8UbG+WHzQLgJJUIkQ=">
<textarea name=fields[message] placeholder="Вы можете использовать синтаксис Markdown" rows=6 required></textarea>
<input name=fields[name] type=text placeholder=имя required>
<input type=email name=fields[email] placeholder=email required><div class=g-recaptcha data-sitekey=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ></div><button id=submit>Отправить</button>
<button id=cancel-button class=d-none data-toggle=reply-form-cancel>Отменить</button></form></section></article></main><footer class=footer><span>&copy; 2021 <a href=https://aybe.org/>Ayrat Belyaev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>