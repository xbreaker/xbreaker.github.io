<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro | Ayrat Belyaev</title><meta name=keywords content="udm,udm pro,ubiquiti,digitalocean,dyndns"><meta name=description content="Настройка Digital Ocean в качестве Dynamic DNS провайдера на Ubiquiti Unifi Dream Machine"><meta name=author content="Ayrat Belyaev"><link rel=canonical href=https://aybe.org/2021/06/udm-dyndns-for-digitalocean/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6133e054c3af07b39ba41b5d09b207d60fd550c8a1ca6cb5f4e8423fcbb9ef96.css integrity="sha256-YTPgVMOvB7ObpBtdCbIH1g/VUMihymy19OhCP8u575Y=" rel="preload stylesheet" as=style><link rel=preload href=/img/avatar-35.jpg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://aybe.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aybe.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aybe.org/favicon-32x32.png><link rel=apple-touch-icon href=https://aybe.org/apple-touch-icon.png><link rel=mask-icon href=https://aybe.org/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script defer crossorigin=anonymous src=/assets/js/comments.min.49d45403fc9dbe8573d9febfb47e24d937d6de152a024f980b98e296fc25977b.js integrity="sha256-SdRUA/ydvoVz2f6/tH4k2TfW3hUqAk+YC5jilvwll3s="></script><script src=https://www.google.com/recaptcha/api.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-MFD8PM59LW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MFD8PM59LW',{anonymize_ip:!1})}</script><meta property="og:title" content="Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro"><meta property="og:description" content="Настройка Digital Ocean в качестве Dynamic DNS провайдера на Ubiquiti Unifi Dream Machine"><meta property="og:type" content="article"><meta property="og:url" content="https://aybe.org/2021/06/udm-dyndns-for-digitalocean/"><meta property="og:image" content="https://aybe.org/images/udm_dyndns_for_digitalocean_0.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-20T18:42:01+03:00"><meta property="article:modified_time" content="2021-08-02T16:22:14+03:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aybe.org/images/udm_dyndns_for_digitalocean_0.png"><meta name=twitter:title content="Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro"><meta name=twitter:description content="Настройка Digital Ocean в качестве Dynamic DNS провайдера на Ubiquiti Unifi Dream Machine"><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Записи",
      "item": "https://aybe.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UDM",
      "item": "https://aybe.org/posts/udm/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro",
      "item": "https://aybe.org/2021/06/udm-dyndns-for-digitalocean/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro",
  "name": "Использование Digital Ocean в качестве Dynamic DNS для UDM\/UDM Pro",
  "description": "Настройка Digital Ocean в качестве Dynamic DNS провайдера на Ubiquiti Unifi Dream Machine",
  "keywords": [
    "udm", "udm pro", "ubiquiti", "digitalocean", "dyndns"
  ],
  "articleBody": "Кроме основного варианта обновления Dynamic DNS, который я рассматривал ранее я решил сделать резервный вариант обновления, так как доступ к домашнему серверу достаточно критичен и используется мной постоянно. Наиболее простой вариант резервирования - это проверка и обновление настроек Dynamic DNS по расписанию.\nДля управления своими доменами использую Digital Ocean, поэтому возникла проблема динамическим управлением доменными записями при подключении к интернету, так как дома у меня динамический “белый” IP адрес. Как мы помним основной вариант обновления настроек у меня - это приложение Heroku, которое позволяет управлять доменными записями на DigitalOcean посредством URL-запросов с авторизацией, что-то вида:\n# curl -v http://test:test@myapp.herokuapp.com/dyndns/home.site.com/@IP  GET / HTTP/1.1  Host: myapp.herokuapp.com  User-Agent: curl/7.71.1  Accept: */*  200 OK =utf-8 9 11 Jan 2020 08:17:33 GMT for home.site.com was updated to 127.0.0.1 В UDM для реализации поддержки Dynamic DNS внутри UDM используется inadyn, более подробное исследование inadyn есть всё в той же отдельной статье, где я рассказывал как заставить работать UDM с любым dyndns провайдером.\nКроме этого в UDM есть поддержка контейнеризации на основе Podman и именно её я и буду использовать - контейнер, который раз в 5 минут производит запрос к сайту определения IP, сравнивает его с IP адресом моего DynDNS хоста и, при необходимости, обновляет его.\nПодготовка Digital Ocean Для начала проверим настройки Digital Ocean и убедимся, что у нас есть возможность управлять доменными записями через API. Управление доменами расположено в секции Networking - Domains, где необходимо добавить свой домен и настроить поддомен, который мы будем использовать для Dynamic DNS, пусть для примера это будет dyndns.aybe.org, IP адрес пока можно ввести любой:\n  Добавление новой записи для домена\n  Второй шаг - создание API токена, с помощью которого мы будем обновлять эту доменную запись. Управление токенам расположено в разделе API, где нажимаем кнопку Generate New Token и вводим его название, чтобы было понятно для чего он, например udm-dyndns-token. Обязательно ставим галку напротив Write, чтобы у токена были права на запись:\n  Создание API токена\n  После создания не забываем скопировать его, так как в дальнейшем подсмотреть его будет нельзя, только удалить старый и создать новый:\n  Скопируйте и сохраните значение токена\n  Настройка UDM Переходим ко второй части - к контейнеру. Так как у меня уже установлены udm-utilities и есть возможность автозапуска после рестарта роутера, а значит уже все готово к использованию Podman и его контейнеров, осталось только написать или найти нужный. Самому реализовывать не пришлось, так как нашел готовую репу - digitalocean-dyndns.\nКоманда запуска для Podman будет выглядеть так:\n# podman run -d --network=host --restart always \\ --name dyndns \\ \t-e DIGITALOCEAN_TOKEN=\"737e7...................................ef6ab\" \\ \t-e DOMAIN=\"aybe.org\" \\ \t-e NAME=\"dyndns\" \\ \t-e SLEEP_INTERVAL=300 \\ \t-e REMOVE_DUPLICATES=\"true\" \\ \ttunix/digitalocean-dyndns После завершения работы команды можно проверить, что контейнер создался и запущен:\n# podman ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES dfa88f5bab0e tunix/digitalocean-dyndns:latest 1 mins ago Up 1 mins ago dyndns Однако, IP в моем случае не обновился, а значит контейнер работает некорректно. Проверяем логи, а там одни ошибки:\n# podman logs dyndns standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” standard_init_linux.go:178: exec user process caused “exec format error” Оказалось, что контейнер собран для архитектуры, которая не подходит для UDM, так как у нас используется архитектура arm64, а в контейнере amd64:\n# podman inspect 5250704bc580 | grep \"Architecture\" \"Architecture\": \"amd64\", Поэтому скрипт внутри контейнера просто не запускается, следовательно, необходимо этот контейнер пересобрать под нужную нам архитектуру. К счастью, сделать это можно прямо на UDM, для начала создать каталог и скачать скрипты из репозитория:\n# mkdir /mnt/data/tmpdyndns \u0026\u0026 cd \"$_\" # curl -o Dockerfile https://raw.githubusercontent.com/tunix/digitalocean-dyndns/master/Dockerfile # curl -o dyndns.sh https://raw.githubusercontent.com/tunix/digitalocean-dyndns/master/dyndns.sh # chmod +x dyndns.sh После этого можно собрать контейнер под нашу платформу и сразу проверить, что image создался, а также удалить стандартный, который нам не подходит:\n# podman build -t tunix/digitalocean-dyndns --platform linux/arm64 . # podman images REPOSITORY TAG IMAGE ID CREATED SIZE R/O localhost/tunix/digitalocean-dyndns latest b7c3b250bbac 3 mins ago 11.2 MB false docker.io/tunix/digitalocean-dyndns latest 5250704bc580 15 mins ago 11.6 MB false docker.io/library/alpine latest b0e47758dc53 3 mins ago 5.6 MB false # podman container stop dyndns # podman container rm dyndns # podman image rm 5250704bc580 Untagged: docker.io/tunix/digitalocean-dyndns:latest Deleted: 5250704bc580f4761dfc0692046b6dc5e9e1bcc184dad131d5f065cf3feaa89a Повторяем команду создания и запуска контейнера с использованием нового образа, и проверяем в логах что все работает: # podman run -d --network=host --restart always \\ --name dyndns \\ \t-e DIGITALOCEAN_TOKEN=\"737e7...................................ef6ab\" \\ \t-e DOMAIN=\"aybe.org\" \\ \t-e NAME=\"dyndns\" \\ \t-e SLEEP_INTERVAL=300 \\ \t-e REMOVE_DUPLICATES=\"true\" \\ \tlocalhost/tunix/digitalocean-dyndns # podman ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES dfa88f5bab0e localhost/tunix/digitalocean-dyndns:latest 3 mins ago Up 3 mins ago dyndns # podman logs dyndns Trying with ifconfig.co... Trying with ipinfo.io/ip... Found IP address 5.11.11.11 existing DNS record address (127.0.0.1) doesn't match current IP (5.11.11.11), sending data={\"type\": \"A\", \"name\": \"dyndns\", \"data\": \"5.11.11.11\"} to url=https://api.digitalocean.com/v2/domains/aybe.org/records/1111111\nТеперь все работает корректно, осталось реализовать старт контейнера при перезагрузке роутера или обновлении, для этого в каталоге /mnt/data/on_bood.d/ создадим новый файл 10-dyndns.sh со следующим содержимым:\n#!/bin/sh CONTAINER=dyndns if podman container exists ${CONTAINER}; then podman start ${CONTAINER} else logger -s -t podman -p ERROR Container $CONTAINER not found, make sure you set the proper name, you can ignore this error if it is your first time setting it up fi Если у вас нет каталога on_boot.d, то значит у вас не установлены udm-utilities, необходимо установить их. Не забываем сделать этот файл исполняемым:\n# chmod +x 10-dyndns.sh На этом настройку можно считать завершенной.\n Если вы ранее не использовали Digital Ocean и хотите попробовать, то предлагаю использовать реферальную ссылку, с которой вы получите 100 долларов на счет после регистрации, которые будут доступны вам 60 дней.\n ",
  "wordCount" : "961",
  "inLanguage": "ru",
  "image":"https://aybe.org/images/udm_dyndns_for_digitalocean_0.png","datePublished": "2021-06-20T18:42:01+03:00",
  "dateModified": "2021-08-02T16:22:14+03:00",
  "author":{
    "@type": "Person",
    "name": "Ayrat Belyaev"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://aybe.org/2021/06/udm-dyndns-for-digitalocean/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ayrat Belyaev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://aybe.org/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://aybe.org/ accesskey=h title="Ayrat Belyaev (Alt + H)"><img src=/img/avatar-35.jpg alt=logo aria-label=logo height=35>Ayrat Belyaev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://aybe.org/search title=поиск><span>поиск</span></a></li><li><a href=https://aybe.org/archives title=архив><span>архив</span></a></li><li><a href=https://aybe.org/tags title=теги><span>теги</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aybe.org/>Главная</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/>Записи</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/udm/>UDM</a></div><h1 class=post-title>Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro</h1><div class=post-description>Настройка Digital Ocean в качестве Dynamic DNS провайдера на Ubiquiti Unifi Dream Machine</div><div class=post-meta>June 20, 2021&nbsp;·&nbsp;5 мин&nbsp;·&nbsp;Ayrat Belyaev</div></header><figure class=entry-cover><img loading=lazy srcset="https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0_hubd536f802df0a09c4dd808400364a517_75002_360x0_resize_box_2.png 360w ,https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0_hubd536f802df0a09c4dd808400364a517_75002_480x0_resize_box_2.png 480w ,https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0_hubd536f802df0a09c4dd808400364a517_75002_720x0_resize_box_2.png 720w ,https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0_hubd536f802df0a09c4dd808400364a517_75002_1080x0_resize_box_2.png 1080w ,https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0.png 1137w" sizes="(min-width: 768px) 720px, 100vw" src=https://aybe.org/2021/06/udm-dyndns-for-digitalocean/images/udm_dyndns_for_digitalocean_0.png alt></figure><div class=post-content><p>Кроме основного варианта обновления Dynamic DNS, который я рассматривал <a href=https://aybe.org/2021/06/custom-dyndns-for-udm/ title="Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine">ранее</a> я решил сделать резервный вариант обновления, так как доступ к домашнему серверу достаточно критичен и используется мной постоянно. Наиболее простой вариант резервирования - это проверка и обновление настроек Dynamic DNS по расписанию.</p><p>Для управления своими доменами использую <a href=https://m.do.co/c/945ae9897cbd>Digital Ocean</a>, поэтому возникла проблема динамическим управлением доменными записями при подключении к интернету, так как дома у меня динамический &ldquo;белый&rdquo; IP адрес. Как мы помним основной вариант обновления настроек у меня - это приложение Heroku, которое позволяет управлять доменными записями на DigitalOcean посредством URL-запросов с авторизацией, что-то вида:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># curl -v http://test:test@myapp.herokuapp.com/dyndns/home.site.com/@IP</span>

&gt; GET / HTTP/1.1
&gt; Host: myapp.herokuapp.com
&gt; User-Agent: curl/7.71.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span style=color:#ae81ff>200</span> OK
&lt; Server: Cowboy
&lt; Connection: keep-alive
&lt; Content-Type: text/html; charset<span style=color:#f92672>=</span>utf-8
&lt; Content-Length: <span style=color:#ae81ff>9</span>
&lt; Date: Mon, <span style=color:#ae81ff>11</span> Jan <span style=color:#ae81ff>2020</span> 08:17:33 GMT
&lt; Via: 1.1 vegur
&lt;
IP <span style=color:#66d9ef>for</span> home.site.com was updated to 127.0.0.1</code></pre></div><p>В UDM для реализации поддержки Dynamic DNS внутри UDM используется <a href=https://github.com/troglobit/inadyn>inadyn</a>, более подробное исследование inadyn есть всё в той же <a href=https://aybe.org/2021/06/custom-dyndns-for-udm/ title="Использование своего Dynamic DNS сервиса на Ubiquti Unifi Dream Machine">отдельной статье</a>, где я рассказывал как заставить работать UDM с любым dyndns провайдером.</p><p>Кроме этого в UDM есть поддержка контейнеризации на основе <a href=https://podman.io/>Podman</a> и именно её я и буду использовать - контейнер, который раз в 5 минут производит запрос к сайту определения IP, сравнивает его с IP адресом моего DynDNS хоста и, при необходимости, обновляет его.</p><h3 id=подготовка-digital-ocean>Подготовка Digital Ocean<a hidden class=anchor aria-hidden=true href=#подготовка-digital-ocean>#</a></h3><p>Для начала проверим настройки Digital Ocean и убедимся, что у нас есть возможность управлять доменными записями через API.
Управление доменами расположено в секции Networking -> <a href=https://cloud.digitalocean.com/networking/domains>Domains</a>, где необходимо добавить свой домен и настроить поддомен, который мы будем использовать для Dynamic DNS, пусть для примера это будет <code>dyndns.aybe.org</code>, IP адрес пока можно ввести любой:</p><figure><img loading=lazy src=images/udm_dyndns_for_digitalocean_1.png alt="Добавление новой записи для домена"><figcaption><p>Добавление новой записи для домена</p></figcaption></figure><p>Второй шаг - создание API токена, с помощью которого мы будем обновлять эту доменную запись. Управление токенам расположено в разделе <a href=https://cloud.digitalocean.com/account/api/tokens>API</a>, где нажимаем кнопку <em>Generate New Token</em> и вводим его название, чтобы было понятно для чего он, например <code>udm-dyndns-token</code>. Обязательно ставим галку напротив Write, чтобы у токена были права на запись:</p><figure><img loading=lazy src=images/udm_dyndns_for_digitalocean_2.png alt="Создание API токена"><figcaption><p>Создание API токена</p></figcaption></figure><p>После создания не забываем скопировать его, так как в дальнейшем подсмотреть его будет нельзя, только удалить старый и создать новый:</p><figure><img loading=lazy src=images/udm_dyndns_for_digitalocean_3.png alt="Скопируйте и сохраните значение токена"><figcaption><p>Скопируйте и сохраните значение токена</p></figcaption></figure><h3 id=настройка-udm>Настройка UDM<a hidden class=anchor aria-hidden=true href=#настройка-udm>#</a></h3><p>Переходим ко второй части - к контейнеру. Так как у меня уже установлены <a href=https://github.com/boostchicken/udm-utilities>udm-utilities</a> и есть возможность автозапуска после рестарта роутера, а значит уже все готово к использованию Podman и его контейнеров, осталось только написать или найти нужный. Самому реализовывать не пришлось, так как нашел готовую репу - <a href=https://github.com/tunix/digitalocean-dyndns>digitalocean-dyndns</a>.</p><p>Команда запуска для Podman будет выглядеть так:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman run -d --network=host --restart always \</span>
	--name dyndns <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e DIGITALOCEAN_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;737e7...................................ef6ab&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e DOMAIN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aybe.org&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dyndns&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e SLEEP_INTERVAL<span style=color:#f92672>=</span><span style=color:#ae81ff>300</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e REMOVE_DUPLICATES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	tunix/digitalocean-dyndns</code></pre></div><p>После завершения работы команды можно проверить, что контейнер создался и запущен:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman ps</span>
CONTAINER ID  IMAGE                                       COMMAND               CREATED       STATUS          PORTS  NAMES
dfa88f5bab0e  tunix/digitalocean-dyndns:latest                                  <span style=color:#ae81ff>1</span> mins ago    Up <span style=color:#ae81ff>1</span> mins ago          dyndns</code></pre></div><p>Однако, IP в моем случае не обновился, а значит контейнер работает некорректно. Проверяем логи, а там одни ошибки:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman logs dyndns</span>
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”
standard_init_linux.go:178: exec user process caused “exec format error”</code></pre></div><p><a href=https://stackoverflow.com/a/67755255>Оказалось</a>, что контейнер собран для архитектуры, которая не подходит для UDM, так как у нас используется архитектура arm64, а в контейнере amd64:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman inspect 5250704bc580 | grep &#34;Architecture&#34;</span>
        <span style=color:#e6db74>&#34;Architecture&#34;</span>: <span style=color:#e6db74>&#34;amd64&#34;</span>,</code></pre></div><p>Поэтому скрипт внутри контейнера просто не запускается, следовательно, необходимо этот контейнер пересобрать под нужную нам архитектуру. К счастью, сделать это можно прямо на UDM, для начала создать каталог и скачать скрипты из репозитория:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># mkdir /mnt/data/tmpdyndns &amp;&amp; cd &#34;$_&#34;</span>
<span style=color:#75715e># curl -o Dockerfile https://raw.githubusercontent.com/tunix/digitalocean-dyndns/master/Dockerfile</span>
<span style=color:#75715e># curl -o dyndns.sh https://raw.githubusercontent.com/tunix/digitalocean-dyndns/master/dyndns.sh</span>
<span style=color:#75715e># chmod +x dyndns.sh</span></code></pre></div><p>После этого можно собрать контейнер под нашу платформу и сразу проверить, что image создался, а также удалить стандартный, который нам не подходит:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman build -t tunix/digitalocean-dyndns --platform linux/arm64 .</span>
<span style=color:#75715e># podman images</span>
REPOSITORY                            TAG       IMAGE ID       CREATED        SIZE      R/O
localhost/tunix/digitalocean-dyndns   latest    b7c3b250bbac   <span style=color:#ae81ff>3</span> mins ago     11.2 MB   false
docker.io/tunix/digitalocean-dyndns   latest    5250704bc580   <span style=color:#ae81ff>15</span> mins ago    11.6 MB   false
docker.io/library/alpine              latest    b0e47758dc53   <span style=color:#ae81ff>3</span> mins ago     5.6 MB    false
<span style=color:#75715e># podman container stop dyndns</span>
<span style=color:#75715e># podman container rm dyndns</span>
<span style=color:#75715e># podman image rm 5250704bc580</span>
Untagged: docker.io/tunix/digitalocean-dyndns:latest
Deleted: 5250704bc580f4761dfc0692046b6dc5e9e1bcc184dad131d5f065cf3feaa89a</code></pre></div><p>Повторяем команду создания и запуска контейнера с использованием нового образа, и проверяем в логах что все работает:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># podman run -d --network=host --restart always \</span>
	--name dyndns <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e DIGITALOCEAN_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;737e7...................................ef6ab&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e DOMAIN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aybe.org&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dyndns&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e SLEEP_INTERVAL<span style=color:#f92672>=</span><span style=color:#ae81ff>300</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-e REMOVE_DUPLICATES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	localhost/tunix/digitalocean-dyndns
<span style=color:#75715e># podman ps</span>
CONTAINER ID  IMAGE                                       COMMAND               CREATED       STATUS          PORTS  NAMES
dfa88f5bab0e  localhost/tunix/digitalocean-dyndns:latest                        <span style=color:#ae81ff>3</span> mins ago    Up <span style=color:#ae81ff>3</span> mins ago          dyndns
<span style=color:#75715e># podman logs dyndns</span>
Trying with ifconfig.co...
Trying with ipinfo.io/ip...
Found IP address 5.11.11.11
existing DNS record address <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t match current IP <span style=color:#f92672>(</span>5.11.11.11<span style=color:#f92672>)</span>, 
sending data<span style=color:#f92672>={</span><span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;A&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;dyndns&#34;</span>, <span style=color:#e6db74>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;5.11.11.11&#34;</span><span style=color:#f92672>}</span> 
to url<span style=color:#f92672>=</span>https://api.digitalocean.com/v2/domains/aybe.org/records/1111111</code></pre></div></p><p>Теперь все работает корректно, осталось реализовать старт контейнера при перезагрузке роутера или обновлении, для этого в каталоге <code>/mnt/data/on_bood.d/</code> создадим новый файл <code>10-dyndns.sh</code> со следующим содержимым:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/sh
</span><span style=color:#75715e></span>CONTAINER<span style=color:#f92672>=</span>dyndns

<span style=color:#66d9ef>if</span> podman container exists <span style=color:#e6db74>${</span>CONTAINER<span style=color:#e6db74>}</span>; <span style=color:#66d9ef>then</span>
  podman start <span style=color:#e6db74>${</span>CONTAINER<span style=color:#e6db74>}</span>
<span style=color:#66d9ef>else</span>
  logger -s -t podman -p ERROR Container $CONTAINER not found, make sure you set the proper name, you can ignore this error <span style=color:#66d9ef>if</span> it is your first time setting it up
<span style=color:#66d9ef>fi</span></code></pre></div><p>Если у вас нет каталога <code>on_boot.d</code>, то значит у вас не установлены <a href=https://github.com/boostchicken/udm-utilities>udm-utilities</a>, необходимо установить их. Не забываем сделать этот файл исполняемым:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># chmod +x 10-dyndns.sh</span></code></pre></div><p>На этом настройку можно считать завершенной.</p><blockquote><p>Если вы ранее не использовали Digital Ocean и хотите попробовать, то предлагаю использовать <a href=https://m.do.co/c/945ae9897cbd>реферальную ссылку</a>, с которой вы получите 100 долларов на счет после регистрации, которые будут доступны вам 60 дней.</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://aybe.org/tags/udm/>udm</a></li><li><a href=https://aybe.org/tags/udm-pro/>udm pro</a></li><li><a href=https://aybe.org/tags/ubiquiti/>ubiquiti</a></li><li><a href=https://aybe.org/tags/digitalocean/>digitalocean</a></li><li><a href=https://aybe.org/tags/dyndns/>dyndns</a></li></ul><nav class=paginav><a class=prev href=https://aybe.org/2021/07/staticman-comments-for-github-pages/><span class=title>« Предыдущая</span><br><span>Добавление Staticman комментариев на статичные сайты (github-pages)</span></a>
<a class=next href=https://aybe.org/2021/06/custom-dyndns-for-udm/><span class=title>Следующая »</span><br><span>Использование своего Dynamic DNS сервиса на Ubiquiti Unifi Dream Machine</span></a></nav></footer><section id=comment-thread class="js-comments comment-thread"><form id=reply-form class="js-form reply-form" method=post action=https://aybeorg.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments><h3 id=reply-form-head>Добавить комментарий</h3><div id=notice class=notice></div><input type=hidden name=options[slug] value=/udm-dyndns-for-digitalocean>
<input type=hidden name=options[parent] value=https://aybe.org/2021/06/udm-dyndns-for-digitalocean/>
<input id=input-thread type=hidden name=fields[thread]>
<input id=input-parent type=hidden name=fields[parent]>
<input id=input-parentName type=hidden name=fields[parentName]>
<input type=hidden name=options[reCaptcha][siteKey] value=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ>
<input type=hidden name=options[reCaptcha][secret] value="w0e8kjpH56nyKZkvYX0Oe4kOTSOxu3c1rr2Cw4L67iB0Gx1MTBSemXn0pY+05X3Lezu/FEORlYMB15Mr9lZHSDhdpkee2l3dw3SMD7BAkJpAErtXqyC5PsSinCsZf0989VObxa/74QAp+NyF7Zr4lbY+equDeBPN9p/TqwSv0jn5Wdj2xJOoCfdThiAEeN+6DRXIqnnIMWZ6PPVkiYuBQb8zYvywNgaJ18ctucTKlnOI3SsVR8G4R86jtkvn/+cl9u+2Tu61yS1HPwz78/Aips9OdRFcLdsConD6QqbJV4R0lKFArqjD7smPKal3z/WqH1P4gED54NuNSI6VQt+Tu0J25qgEmZuL+3tJp+Jr1WyGCjrHdvatxa/dTDQgV2F+XLSLd/RmC9GbT3ukEB1CI/IFvznuj4iHtBNog7v7mwht4CVUGzIsaHNSkzMdjP/Tbt8K7YptjkhyUISuamDwbauXiTUlQishzwP8l3iM0CJRh3gKQGBP9u5svoctjCgzQzjgHfqHDgnKD2oyzSl4l4/UmwetxCEkvmY9h05VinAqMKu+wg1TTpKh0xJ0LW7TGoctfoupnzM+XTUy0UGxHBNdVFDVoP9xoQcZgkfw2yWm96t3K78kRMqWbiNqw0ZuJPy6x1IFeuPLh9CLhwflfkJW1j8UbG+WHzQLgJJUIkQ=">
<textarea name=fields[message] placeholder="Вы можете использовать синтаксис Markdown" rows=6 required></textarea>
<input name=fields[name] type=text placeholder=имя required>
<input type=email name=fields[email] placeholder=email required><div class=g-recaptcha data-sitekey=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ></div><button id=submit>Отправить</button>
<button id=cancel-button class=d-none data-toggle=reply-form-cancel>Отменить</button></form></section></article></main><footer class=footer><span>&copy; 2022 <a href=https://aybe.org/>Ayrat Belyaev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>