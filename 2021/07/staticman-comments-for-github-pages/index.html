<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Добавление Staticman комментариев на статичные сайты (github-pages) | Ayrat Belyaev</title><meta name=keywords content="github,github-pages,comments,howto,hugo"><meta name=description content="Добавляем на статический HTML сайт возможность комментирования с помощью библиотеки Staticman"><meta name=author content="Ayrat Belyaev"><link rel=canonical href=https://aybe.org/2021/07/staticman-comments-for-github-pages/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6133e054c3af07b39ba41b5d09b207d60fd550c8a1ca6cb5f4e8423fcbb9ef96.css integrity="sha256-YTPgVMOvB7ObpBtdCbIH1g/VUMihymy19OhCP8u575Y=" rel="preload stylesheet" as=style><link rel=preload href=/img/avatar-35.jpg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://aybe.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aybe.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aybe.org/favicon-32x32.png><link rel=apple-touch-icon href=https://aybe.org/apple-touch-icon.png><link rel=mask-icon href=https://aybe.org/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script defer crossorigin=anonymous src=/assets/js/comments.min.70dce0ef190a617cbc8c42892eb4d253d8f1f6e9ecef13bb9aedba8a84cb5278.js integrity="sha256-cNzg7xkKYXy8jEKJLrTSU9jx9uns7xO7mu26ioTLUng="></script><script src=https://www.google.com/recaptcha/api.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-MFD8PM59LW"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MFD8PM59LW',{anonymize_ip:!1})}</script><meta property="og:title" content="Добавление Staticman комментариев на статичные сайты (github-pages)"><meta property="og:description" content="Добавляем на статический HTML сайт возможность комментирования с помощью библиотеки Staticman"><meta property="og:type" content="article"><meta property="og:url" content="https://aybe.org/2021/07/staticman-comments-for-github-pages/"><meta property="og:image" content="https://aybe.org/img/posts/staticman_0.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-12T10:17:01+03:00"><meta property="article:modified_time" content="2021-07-27T17:37:57+03:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aybe.org/img/posts/staticman_0.png"><meta name=twitter:title content="Добавление Staticman комментариев на статичные сайты (github-pages)"><meta name=twitter:description content="Добавляем на статический HTML сайт возможность комментирования с помощью библиотеки Staticman"><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Записи",
      "item": "https://aybe.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Сайты",
      "item": "https://aybe.org/posts/site/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Добавление Staticman комментариев на статичные сайты (github-pages)",
      "item": "https://aybe.org/2021/07/staticman-comments-for-github-pages/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Добавление Staticman комментариев на статичные сайты (github-pages)",
  "name": "Добавление Staticman комментариев на статичные сайты (github-pages)",
  "description": "Добавляем на статический HTML сайт возможность комментирования с помощью библиотеки Staticman",
  "keywords": [
    "github", "github-pages", "comments", "howto", "hugo"
  ],
  "articleBody": "Данный сайт использует распространенный вариант хостинга с использование Github - при каждом изменении с помощью github-actions генерируется статичный сайт со всеми страницами. Из-за этого нет возможности использовать динамический контент напрямую, например, комментарии к статьям. Есть возможность использовать Disqus, но в таком случае появляется зависимость от сторонних сервисов.\nЛучшим вариантом я считаю хранить комментарии у себя в репозитории, которые будут появлятся на сайте в момент генерации сайта. Сервисов для реализации такого функционала очень много - как бесплатных, так и платных. Я остановлюсь на бесплатном варианте - Staticman от Eduardo Bouças, как наиболее продвинутом и удобном.\nКак это работает:\n Посетитель блога отправляет комментарий, используя форму отправки под любым постом. В форме есть javascript, который отправляет результат на специальную API-прокладку, запущенную в виде приложения на Heroku. Если у пользователя отключен JS, то будет сформирован простой POST запрос. В свою очередь приложение производит валидацию комментария и, в случае успешного результата, создает pull request в репозиторий сайта, содержащий файл .yml с комментарием и мета данными. После принятия мной PR github автоматически генерирует новый сайт и комментарий появляется на сайте.  Сейчас у Staticman есть три версии API и основная сложность его подключения заключается в деплое приложения API-прокладки и настройки его. Мы будем использовать вторую версию, которая не сильно отличается от третьей (в третьей появилась возможность использовать Gitlab).\nСоздание аккаунта бота Для создания pull request’ов в нашу репу используется гитхабовский personal access token, поэтому необходимо создать отдельный аккаунт для этого токена, так как этот токен будет использован для приложения Heroku, а, следовательно, может быть скомпрометирован и кто-то может получить доступ к вашему основному аккаунту. Кроме этого, использование второго аккаунта позволяет удобно разделить коммиты комментариев от ваших правок в репозитории сайта.\nАккаунт бота ничем не отличается от обычного аккаунта Github, поэтому запускаем вкладку в инкогнито режиме, чтобы не выходить из своего аккаунта и создаем новый аккаунт с именем, которое вам нравится, пусть для статьи это будет github-bot. Можно сразу создать README.md в личной репе (название такое же как у аккаунта) и написать, что это бот:\n  Аккаунт нашего трудяги\n  После создания аккаунта нам необходимо сделать две вещи:\n Создать personal access token, для использования его в приложении. Выдать доступ к репозиторию сайта основного аккаунта.  Personal access token Создание токена производится в настройках аккаунта в разделе Developer settings - Personal access tokens. Там нажимаем Generate new token, вводим пароль для безопасности, придумываем название токена и выдаем разрешение к двум разделам - repo и user:\n  Нужные нам права доступа\n  После этого нажимаем Generate token и сохраняем где-нибудь отображенный токен - далее Github не даст его подсмотреть в целях безопасности. Далее в статье этот токен я будут обозначать как github-token. Подробнее прочитать, что такое токен и для чего он может быть использован можно в оффициальной документации Github.\nДоступ к репозиторию Чтобы бот мог коммитить напрямую в наш репозиторий ему необходимо выдать права к репозиторию. Сделаем мы это через добавление бота в коллабораторы репы. Для этого переходим в настройки репы, там Manage access, а далее жмем кнопку Invite collaborator. В окошке вводим имя бота и отправляем приглашение.\n  Отправка приглашения\n  Все, боту придет письмо со кнопкой принятия приглашения - не нажимаем ее, так как принимать приглашение мы будем через наше приложение - это будет дополнительным этапом проверки правильности работы приложения.\nПриложение API Теперь нужно подговить приложение для API-прослойки, которое будет принимать комментарии и создавать PR в наш репозиторий. Делать я это буду на Heroku, так как там имеется возможность использовать бесплатный инстанс, который по расчетам хватит примерно на ~1100 комментариев в месяц для аккаунта без кредитной карты (550 бесплатных часов) или ~4000 комментариев, если добавить кредитную карту в аккаунт (2000 бесплатных часов). Расчет таков - при отправке комментария приложение на Heroku просыпается и засыпает через 30 минут, таким образом в первом случае это 550/0.5 и 2000/0.5 во втором.\nДеплой приложения в Heroku После регистрации в Heroku нам необходимо создать свое приложение, проще всего это сделать из репозитория Staticman, где в README.md есть прямая ссылка не деплой:\n  Deploy приложения из репозитория Staticman\n  Второй вариант - использовать для деплоя прямую ссылку. Если сделали все правильно, то вместо стандартной формы создания приложения мы увидим создание приложения Staticman:\n  Создание нового приложения\n  Вводим имя приложения (далее я его буду обозначать как app-name). Дожидаемся окончания деплоя и сборки нашего прилоежния, открываем его по кнопке Open app и убеждаемся, что ничего не запустилось 😀. Все потому, что приложению не хватает обязательных переменных, поэтому переходим к его настройке.\nГенерация RSA ключа Данный ключ нужен для шифрования секретных значений, которые выложены в публичный доступ, например, ваш секретный токен сервиса reCAPTCHA. Данные шифруются открытым ключом и попадают в публичный доступ, а API приложение расшифровывает их закрытым ключом. Если открыть логи приложения Staticman, то мы увидим, что отсуствие ключа как раз и мешает ему запуститься:\n  Ошибка запуска\n  Для генерации нового ключа используется команда:\n# ssh-keygen -m PEM -t rsa -b 4096 -C \"staticmankey\" -f ~/.ssh/staticman_key Generating public/private rsa key pair. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in staticman_key. Your public key has been saved in staticman_key.pub. The key fingerprint is: SHA256:VSMjbe....................iwPb67BXU8 staticmankey Я не использовал пароль, так как после загрузки закрытого ключа в приложение Heroku его можно смело удалить - он нам больше не понадобится.\nПроверить, что сгенирирован правильный ключ можно, открыв его в любом редакторе, либо же выполнить команду:\n# head -2 ~/.ssh/staticman_key -----BEGIN RSA PRIVATE KEY----- MIIJKAIBAAKCAgEAyBStHD4kR9GjI9XZDf4V+QfNyuCbJRXde66WTRD3rDiyzaXC Строка BEGIN RSA PRIVATE KEY означает, что все сделано правильно, любой другой вариант (например, OPENSSH PRIVATE KEY) означает, что что-то пошло не так и этот вариант не заработает.\nНастройка приложения После генерации ключа осталось настроить наше приложение, сделать это можно двумя путями - через web интерфейс, либо через командную строку.\nВ первом случае открываем дэшборд Heroku, выбираем наше приложение, далее Settings, там нас интересует раздел Config Vars. Жмем кнопку Reveal Config Vars и вводим две переменные:\n RSA_PRIVATE_KEY - наш приватный ключ, вносить его можно прямо из файла, можно удалять перенос строк, можно не удалять - разницы никакой, Staticman поймет его в любом случае. GITHUB_TOKEN - наш personal access token бота github-token, который мы создали ранее  Если все правильно, то должно получится так:\n  Переменные приложения\n  Второй вариант добавления настроек - это через командную строку Heroku. Следуя инструкциям, нужно установить командную строку и выполнить вход, после этого станет доступен очень удобный вариант управления приложением. Для внесения наших переменных следует воспользоваться командами:\n# heroku config:add --app app-name \"RSA_PRIVATE_KEY=$(cat ~/.ssh/staticman_key | tr -d '\\n')\" Setting RSA_PRIVATE_KEY and restarting ⬢ app-name... done, v9 RSA_PRIVATE_KEY: -----BEGIN RSA PRIVATE KEY-----MIIJKA..... # heroku config:add --app app-name \"GITHUB_TOKEN=github-token\" Setting GITHUB_TOKEN and restarting ⬢ app-name... done, v10 GITHUB_TOKEN: github-token Обратите внимания, что вместо app-name и github-token следует использовать ваши значения. Проверить, что все правильно можно командой:\n# heroku config --app app-name Теперь открываем наше приложение по ссылке https://app-name.herokuapp.com и мы должны увидеть приветствие Staticman:\nHello from Staticman version 3.0.0! Если его нет, то значит в каком-то пункте вы ошиблись и стоит посмотреть логи Heroku. Теперь мы можем попробовать принять приглашение в репорзиторий сайта, для этого нужно открыть ссылку в формате:\nhttps://app-name.herokuapp.com/v2/connect//\nВ моем случае это\nhttps://app-name.herokuapp.com/v2/connect/xbreaker/xbreaker.github.io\nВ ответ мы должны получить OK! - это означает, что бот принял приглашение, а, следовательно, приложение мы настроили правильно. Если сайт отвечает Invitation not found, то либо мы уже приняли приглашение ранее, либо забыли бота пригласить.\nЕще один способ проверить правильность настроек - в настройках основного аккаунта в разделе Manage access, аккаунт бота перейдет в статус Collaborator:\n  Аккаунт бота с доступом\n  Настройка сайта Пора подготовить наш сайт к использованию комментариев, для этого нам нужно выполнить четыре вещи:\n Создать файл настроек для Staticman Внести в настройки сайта URL нашего API-приложения Создать шаблон комментариев, который будет использован для генерации комментариев к постам Настройка и включение reCAPTCHA  Настройка Staticman Подробно настройка описана в официальной документации, нам нужно создать файл staticman.yml, полный пример заполнения можно найти здесь. Я же приведу сокращенный вариант, который настроен для этого сайта:\n Поля thread, parentName, parent используются для вложенных комментариев. Так же обратите внимание на настройки reCAPTCHA, если планируете ее использовать.\nНастройки в config.yml Здесь нам необходимо внести настройки Staticman, которые будут использоваться при отправке комментария - ссылку на API, плюс вариантивные настройки сервиса reCAPTCHA. Настройки вносятся в файл config.eml, у меня они расположены в params.staticman:\n65 66 67 68 69 70 71 72  params: comments: true staticman: api: https://app-name.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments recaptcha: enabled: false sitekey: 'recaptcha-sitekey' secret: 'recaptcha-secret'   Ссылка на API должна быть вида:\nhttps://app-name.herokuapp.com/v2/entry///main/comments\nОбратите внимание на бранч вашего репозитория, для старых репозиториев это master, для новых - main.\nШаблон комментариев Самый объемный пункт, так как нам нужно подготовить шаблон для своей темы, не забыть про JS, а так же про стили оформления. На моём сайте используется тема PaperMod, поэтому шаблон я буду делать для этой темы. Если вы используете другую тему, то адаптировать мой вариант будет не сложно.\nЯ не стал особо фантазировать, а решил использовать что-нибудь простое, интересный вариант нашелся здесь. Он послужил основой нашего шаблона, который был доработан под нужды статичного сайта - добавлен аватар и удалена голосовалка, так как в условиях статики ее нам не реализовать. Сам шаблон состоит из нескольких файлов, первым будет comments.html - целиком я его приводить не буду, так как он слишком большой, найти его можно 🧾 здесь, я же остановлюсь на паре моментов.\nСклонение окончания числительных, перед комментариями выводится их количество и, в зависимости от числа комментариев, меняется окончание слова “комментарий”. В шаблоне сейчас это выглядит очень громоздко, если кто-то подскажет более изящный вариант - буду очень благодарен.\n6 7 8 9 10 11 12 13 14 15  {{ $c := len $comments }} {{ if (and (eq (mod $c 10) 1) (ne (mod $c 100) 11)) }} h3{{ $c }} комментарийh3 {{ else }} {{ if (and (ge (mod $c 10) 2) (le (mod $c 10) 4) (or (lt (mod $c 100) 10) (ge (mod $c 100) 20))) }} h3{{ $c }} комментарияh3 {{ else }} h3{{ $c }} комментариевh3 {{ end }} {{ end }}   Второй момент - это выделение комментариев автора блога от остальных. Чтобы это работало необходимо в параметры сайта внести параметр emailhash, который содержит md5 хэш вашего почтового адреса. Чтобы его получить, заходим, например, сюда, вводим свою электронную почту и получившийся результат вносим в параметры:\n65 66  params: emailhash: 23463b99b62a72f26ed677cc556c44e8   Файл comments.html следует скопировать в каталог \\layouts\\partials\\.\nВторой файл - это файл стилей comments.css, чтобы он попал в общий файл CSS стилей, придется пойти на хитрость - создать каталог assets\\css\\common\\ и скопировать файл в данный каталог. Исходный код файла можно найти 🧾 здесь.\nВместе с файлом стилей нам нужен файл javascript логики, который добавит интерактивности нашим комментариям и форме отправки - comments.js. Я использовал чистый JS (vanilla), чтобы исключить зависимость от какого-либо фреймворка. Интересный вариант отправки формы я взял отсюда и отсюда. Сам файл можно скопировать в каталог assets\\js\\, подключим мы его в следующем абзаце. Исходный код файла забираем 🧾 здесь.\nЧтобы подключить наш JS файл нам следует создать специальный файл темы extend_head.html он позволяет добавить в HEAD сайта свои инструкции, чем мы и воспользуемся - добавим загрузку и сжатие нашего comments.js. Кроме того, я добавил в него опциональную загрузку файла reCAPTCHA, если она включена в настройках. Копируем 🧾 содержимое и копируем его в каталог \\layouts\\partials\\.\nВсе файлы сразу расположены в этом 💾 gist, я специально не стал давать ссылки на репозиторий этого сайта, а выложил их отдельно. Так как в будущем файлы сайта могут измениться (или некоторые вообще могут быть удалены) и перестанут соответствовать тому, что здесь написано. А gist останется актуальным и нетронутым.\nНастройка и включение reCAPTCHA Выходим на финишную прямую, нам осталось подключить и настроить сервис reCAPTCHA. Данный сервис добавляет на сайт простой вариант проверки при отправке комментария и позволяет сильно снизить количество спам комментариев.\nДля начала следует сходить на официальный сайт и зарегистрироваться. Нам нужна reCAPTCHA v2 Checkbox версия, выбираем ее при регистрации:\n  reCAPTCHA v2 Checkbox\n  Получаем site key и secret key, которые будут использованы далее:\n  Наши секреты\n  Если site key сразу можно внести в настройки сайта и Staticman, то secret key не предназначен, чтобы передаваать его в открытом виде. Поэтому его нужно зашифровать, поможет нам в этом наше ранее созданное приложение API.\nВызываем его по урлу вида:\nhttps://app-name.herokuapp.com/v2/encrypt/secretKey\nИ результат, который оно возвратит и есть наш secret key для настроек. Сохраните обязательно где-нибудь оригинальный secret key на будущее.\nВносим настройки в config.yml и staticman.yml. Вот и все, готово 👍! Можно приступать к тестированию комментариев.\n  reCAPTCHA\n  Итого В этом посте можно посмотреть результат реализации таких комментариев, создаваемые PR после отправки комментария можно найти в репозитории.\n Если у вас есть что добавить или поправить в этой статье - можно вносить правки напрямую.\n ",
  "wordCount" : "2052",
  "inLanguage": "ru",
  "image":"https://aybe.org/img/posts/staticman_0.png","datePublished": "2021-07-12T10:17:01+03:00",
  "dateModified": "2021-07-27T17:37:57+03:00",
  "author":{
    "@type": "Person",
    "name": "Ayrat Belyaev"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://aybe.org/2021/07/staticman-comments-for-github-pages/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ayrat Belyaev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://aybe.org/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://aybe.org/ accesskey=h title="Ayrat Belyaev (Alt + H)"><img src=/img/avatar-35.jpg alt=logo aria-label=logo height=35>Ayrat Belyaev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://aybe.org/search title=поиск><span>поиск</span></a></li><li><a href=https://aybe.org/archives title=архив><span>архив</span></a></li><li><a href=https://aybe.org/tags title=теги><span>теги</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aybe.org/>Главная</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/>Записи</a>&nbsp;»&nbsp;<a href=https://aybe.org/posts/site/>Сайты</a></div><h1 class=post-title>Добавление Staticman комментариев на статичные сайты (github-pages)</h1><div class=post-description>Добавляем на статический HTML сайт возможность комментирования с помощью библиотеки Staticman</div><div class=post-meta>July 12, 2021&nbsp;·&nbsp;10 мин&nbsp;·&nbsp;Ayrat Belyaev&nbsp;·&nbsp;4 комментария</div></header><figure class=entry-cover><img loading=lazy src=https://aybe.org/img/posts/staticman_0.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Оглавление</div></summary><div class=inner><ul><li><a href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%b0%d0%ba%d0%ba%d0%b0%d1%83%d0%bd%d1%82%d0%b0-%d0%b1%d0%be%d1%82%d0%b0 aria-label="Создание аккаунта бота">Создание аккаунта бота</a><ul><li><a href=#personal-access-token aria-label="Personal access token">Personal access token</a></li><li><a href=#%d0%b4%d0%be%d1%81%d1%82%d1%83%d0%bf-%d0%ba-%d1%80%d0%b5%d0%bf%d0%be%d0%b7%d0%b8%d1%82%d0%be%d1%80%d0%b8%d1%8e aria-label="Доступ к репозиторию">Доступ к репозиторию</a></li></ul></li><li><a href=#%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b5-api aria-label="Приложение API">Приложение API</a><ul><li><a href=#%d0%b4%d0%b5%d0%bf%d0%bb%d0%be%d0%b9-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d1%8f-%d0%b2-heroku aria-label="Деплой приложения в Heroku">Деплой приложения в Heroku</a></li><li><a href=#%d0%b3%d0%b5%d0%bd%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f-rsa-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0 aria-label="Генерация RSA ключа">Генерация RSA ключа</a></li><li><a href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d1%8f aria-label="Настройка приложения">Настройка приложения</a></li></ul></li><li><a href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%81%d0%b0%d0%b9%d1%82%d0%b0 aria-label="Настройка сайта">Настройка сайта</a><ul><li><a href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-staticman aria-label="Настройка Staticman">Настройка Staticman</a></li><li><a href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b8-%d0%b2-configyml aria-label="Настройки в config.yml">Настройки в config.yml</a></li><li><a href=#%d1%88%d0%b0%d0%b1%d0%bb%d0%be%d0%bd-%d0%ba%d0%be%d0%bc%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%80%d0%b8%d0%b5%d0%b2 aria-label="Шаблон комментариев">Шаблон комментариев</a></li><li><a href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%b8-%d0%b2%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-recaptcha aria-label="Настройка и включение reCAPTCHA">Настройка и включение reCAPTCHA</a></li><li><a href=#%d0%b8%d1%82%d0%be%d0%b3%d0%be aria-label=Итого>Итого</a></li></ul></li></ul></div></details></div><div class=post-content><p>Данный сайт использует распространенный вариант хостинга с использование Github - при каждом изменении с помощью github-actions генерируется статичный сайт со всеми страницами. Из-за этого нет возможности использовать динамический контент напрямую, например, комментарии к статьям. Есть возможность использовать Disqus, но в таком случае появляется зависимость от сторонних сервисов.</p><p>Лучшим вариантом я считаю хранить комментарии у себя в репозитории, которые будут появлятся на сайте в момент генерации сайта. Сервисов для реализации такого функционала <a href=https://gohugo.io/content-management/comments/>очень много</a> - как бесплатных, так и платных. Я остановлюсь на бесплатном варианте - <a href=https://staticman.net/>Staticman</a> от <a href=https://github.com/eduardoboucas>Eduardo Bouças</a>, как наиболее продвинутом и удобном.</p><p>Как это работает:</p><ol><li>Посетитель блога отправляет комментарий, используя форму отправки под любым постом.</li><li>В форме есть javascript, который отправляет результат на специальную API-прокладку, запущенную в виде приложения на Heroku. Если у пользователя отключен JS, то будет сформирован простой POST запрос.</li><li>В свою очередь приложение производит валидацию комментария и, в случае успешного результата, создает pull request в репозиторий сайта, содержащий файл .yml с комментарием и мета данными.</li><li>После принятия мной PR github автоматически генерирует новый сайт и комментарий появляется на сайте.</li></ol><p>Сейчас у Staticman есть три версии API и основная сложность его подключения заключается в деплое приложения API-прокладки и настройки его. Мы будем использовать вторую версию, которая не сильно отличается от третьей (в третьей появилась возможность использовать Gitlab).</p><h2 id=создание-аккаунта-бота>Создание аккаунта бота<a hidden class=anchor aria-hidden=true href=#создание-аккаунта-бота>#</a></h2><p>Для создания pull request&rsquo;ов в нашу репу используется гитхабовский personal access token, поэтому необходимо создать отдельный аккаунт для этого токена, так как этот токен будет использован для приложения Heroku, а, следовательно, может быть скомпрометирован и кто-то может получить доступ к вашему основному аккаунту.
Кроме этого, использование второго аккаунта позволяет удобно разделить коммиты комментариев от ваших правок в репозитории сайта.</p><p>Аккаунт бота ничем не отличается от обычного аккаунта Github, поэтому запускаем вкладку в инкогнито режиме, чтобы не выходить из своего аккаунта и создаем новый аккаунт с именем, которое вам нравится, пусть для статьи это будет <code>github-bot</code>. Можно сразу создать README.md в личной репе (название такое же как у аккаунта) и написать, что это бот:</p><figure><img loading=lazy src=/img/posts/staticman_1.png alt="Аккаунт нашего трудяги"><figcaption><p>Аккаунт нашего трудяги</p></figcaption></figure><p>После создания аккаунта нам необходимо сделать две вещи:</p><ol><li>Создать personal access token, для использования его в приложении.</li><li>Выдать доступ к репозиторию сайта основного аккаунта.</li></ol><h3 id=personal-access-token>Personal access token<a hidden class=anchor aria-hidden=true href=#personal-access-token>#</a></h3><p>Создание токена производится в настройках аккаунта в разделе Developer settings -> <a href=https://github.com/settings/tokens>Personal access tokens</a>. Там нажимаем Generate new token, вводим пароль для безопасности, придумываем название токена и выдаем разрешение к двум разделам - repo и user:</p><figure><img loading=lazy src=/img/posts/staticman_2.png alt="Нужные нам права доступа"><figcaption><p>Нужные нам права доступа</p></figcaption></figure><p>После этого нажимаем Generate token и сохраняем где-нибудь отображенный токен - далее Github не даст его подсмотреть в целях безопасности. Далее в статье этот токен я будут обозначать как <code>github-token</code>. Подробнее прочитать, что такое токен и для чего он может быть использован можно в <a href=https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line>оффициальной документации</a> Github.</p><h3 id=доступ-к-репозиторию>Доступ к репозиторию<a hidden class=anchor aria-hidden=true href=#доступ-к-репозиторию>#</a></h3><p>Чтобы бот мог коммитить напрямую в наш репозиторий ему необходимо выдать права к репозиторию. Сделаем мы это через добавление бота в коллабораторы репы. Для этого переходим в настройки репы, там Manage access, а далее жмем кнопку Invite collaborator. В окошке вводим имя бота и отправляем приглашение.</p><figure><img loading=lazy src=/img/posts/staticman_3.png alt="Отправка приглашения"><figcaption><p>Отправка приглашения</p></figcaption></figure><p>Все, боту придет письмо со кнопкой принятия приглашения - не нажимаем ее, так как принимать приглашение мы будем через наше приложение - это будет дополнительным этапом проверки правильности работы приложения.</p><h2 id=приложение-api>Приложение API<a hidden class=anchor aria-hidden=true href=#приложение-api>#</a></h2><p>Теперь нужно подговить приложение для API-прослойки, которое будет принимать комментарии и создавать PR в наш репозиторий. Делать я это буду на <a href=https://heroku.com>Heroku</a>, так как там имеется возможность использовать бесплатный инстанс, который по расчетам хватит примерно на ~1100 комментариев в месяц для аккаунта без кредитной карты (550 бесплатных часов) или ~4000 комментариев, если добавить кредитную карту в аккаунт (2000 бесплатных часов). Расчет таков - при отправке комментария приложение на Heroku просыпается и засыпает через 30 минут, таким образом в первом случае это <code>550/0.5</code> и <code>2000/0.5</code> во втором.</p><h3 id=деплой-приложения-в-heroku>Деплой приложения в Heroku<a hidden class=anchor aria-hidden=true href=#деплой-приложения-в-heroku>#</a></h3><p>После регистрации в Heroku нам необходимо создать свое приложение, проще всего это сделать из репозитория Staticman, где в <a href=https://github.com/eduardoboucas/staticman#introduction>README.md</a> есть прямая ссылка не деплой:</p><figure><img loading=lazy src=/img/posts/staticman_6.png alt="Deploy приложения из репозитория Staticman"><figcaption><p>Deploy приложения из репозитория Staticman</p></figcaption></figure><p>Второй вариант - использовать для деплоя <a href="https://heroku.com/deploy?template=https://github.com/eduardoboucas/staticman/tree/master">прямую ссылку</a>. Если сделали все правильно, то вместо стандартной формы создания приложения мы увидим создание приложения Staticman:</p><figure><img loading=lazy src=/img/posts/staticman_5.png alt="Создание нового приложения"><figcaption><p>Создание нового приложения</p></figcaption></figure><p>Вводим имя приложения (далее я его буду обозначать как <code>app-name</code>). Дожидаемся окончания деплоя и сборки нашего прилоежния, открываем его по кнопке Open app и убеждаемся, что ничего не запустилось 😀. Все потому, что приложению не хватает обязательных переменных, поэтому переходим к его настройке.</p><h3 id=генерация-rsa-ключа>Генерация RSA ключа<a hidden class=anchor aria-hidden=true href=#генерация-rsa-ключа>#</a></h3><p>Данный ключ нужен для шифрования секретных значений, которые выложены в публичный доступ, например, ваш секретный токен сервиса reCAPTCHA. Данные шифруются открытым ключом и попадают в публичный доступ, а API приложение расшифровывает их закрытым ключом. Если открыть логи приложения Staticman, то мы увидим, что отсуствие ключа как раз и мешает ему запуститься:</p><figure><img loading=lazy src=/img/posts/staticman_7.png alt="Ошибка запуска"><figcaption><p>Ошибка запуска</p></figcaption></figure><p>Для генерации нового ключа используется команда:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ssh-keygen -m PEM -t rsa -b 4096 -C &#34;staticmankey&#34; -f ~/.ssh/staticman_key</span>
Generating public/private rsa key pair.
Enter passphrase <span style=color:#f92672>(</span>empty <span style=color:#66d9ef>for</span> no passphrase<span style=color:#f92672>)</span>:
Enter same passphrase again:
Your identification has been saved in staticman_key.
Your public key has been saved in staticman_key.pub.
The key fingerprint is:
SHA256:VSMjbe....................iwPb67BXU8 staticmankey</code></pre></div><p>Я не использовал пароль, так как после загрузки закрытого ключа в приложение Heroku его можно смело удалить - он нам больше не понадобится.</p><p>Проверить, что сгенирирован правильный ключ можно, открыв его в любом редакторе, либо же выполнить команду:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># head -2 ~/.ssh/staticman_key</span>
-----BEGIN RSA PRIVATE KEY-----
MIIJKAIBAAKCAgEAyBStHD4kR9GjI9XZDf4V+QfNyuCbJRXde66WTRD3rDiyzaXC</code></pre></div><p>Строка <code>BEGIN RSA PRIVATE KEY</code> означает, что все сделано правильно, любой другой вариант (например, <code>OPENSSH PRIVATE KEY</code>) означает, что что-то пошло не так и этот вариант не заработает.</p><h3 id=настройка-приложения>Настройка приложения<a hidden class=anchor aria-hidden=true href=#настройка-приложения>#</a></h3><p>После генерации ключа осталось настроить наше приложение, сделать это можно двумя путями - через web интерфейс, либо через командную строку.</p><p>В первом случае открываем <a href=https://dashboard.heroku.com/apps>дэшборд Heroku</a>, выбираем наше приложение, далее Settings, там нас интересует раздел Config Vars. Жмем кнопку Reveal Config Vars и вводим две переменные:</p><ol><li><code>RSA_PRIVATE_KEY</code> - наш приватный ключ, вносить его можно прямо из файла, можно удалять перенос строк, можно не удалять - разницы никакой, Staticman поймет его в любом случае.</li><li><code>GITHUB_TOKEN</code> - наш personal access token бота <code>github-token</code>, который мы создали ранее</li></ol><p>Если все правильно, то должно получится так:</p><figure><img loading=lazy src=/img/posts/staticman_8.png alt="Переменные приложения"><figcaption><p>Переменные приложения</p></figcaption></figure><p>Второй вариант добавления настроек - это через командную строку Heroku. Следуя <a href=https://devcenter.heroku.com/articles/heroku-cli>инструкциям</a>, нужно установить командную строку и выполнить вход, после этого станет доступен очень удобный вариант управления приложением. Для внесения наших переменных следует воспользоваться командами:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># heroku config:add --app app-name &#34;RSA_PRIVATE_KEY=$(cat ~/.ssh/staticman_key | tr -d &#39;\n&#39;)&#34;</span>
Setting RSA_PRIVATE_KEY and restarting ⬢ app-name... <span style=color:#66d9ef>done</span>, v9
RSA_PRIVATE_KEY: -----BEGIN RSA PRIVATE KEY-----MIIJKA.....
<span style=color:#75715e># heroku config:add --app app-name &#34;GITHUB_TOKEN=github-token&#34;</span>
Setting GITHUB_TOKEN and restarting ⬢ app-name... <span style=color:#66d9ef>done</span>, v10
GITHUB_TOKEN: github-token</code></pre></div><p>Обратите внимания, что вместо <code>app-name</code> и <code>github-token</code> следует использовать ваши значения. Проверить, что все правильно можно командой:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># heroku config --app app-name</span></code></pre></div><p>Теперь открываем наше приложение по ссылке <code>https://app-name.herokuapp.com</code> и мы должны увидеть приветствие Staticman:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Hello from Staticman version 3.0.0!</code></pre></div><p>Если его нет, то значит в каком-то пункте вы ошиблись и стоит посмотреть логи Heroku. Теперь мы можем попробовать принять приглашение в репорзиторий сайта, для этого нужно открыть ссылку в формате:</p><p><code>https://app-name.herokuapp.com/v2/connect/&lt;main-user-account>/&lt;site-repository></code></p><p>В моем случае это</p><p><code>https://app-name.herokuapp.com/v2/connect/xbreaker/xbreaker.github.io</code></p><p>В ответ мы должны получить <code>OK!</code> - это означает, что бот принял приглашение, а, следовательно, приложение мы настроили правильно. Если сайт отвечает <code>Invitation not found</code>, то либо мы уже приняли приглашение ранее, либо забыли бота пригласить.</p><p>Еще один способ проверить правильность настроек - в настройках основного аккаунта в разделе Manage access, аккаунт бота перейдет в статус Collaborator:</p><figure><img loading=lazy src=/img/posts/staticman_4.png alt="Аккаунт бота с доступом"><figcaption><p>Аккаунт бота с доступом</p></figcaption></figure><h2 id=настройка-сайта>Настройка сайта<a hidden class=anchor aria-hidden=true href=#настройка-сайта>#</a></h2><p>Пора подготовить наш сайт к использованию комментариев, для этого нам нужно выполнить четыре вещи:</p><ol><li>Создать файл настроек для Staticman</li><li>Внести в настройки сайта URL нашего API-приложения</li><li>Создать шаблон комментариев, который будет использован для генерации комментариев к постам</li><li>Настройка и включение reCAPTCHA</li></ol><h3 id=настройка-staticman>Настройка Staticman<a hidden class=anchor aria-hidden=true href=#настройка-staticman>#</a></h3><p>Подробно настройка описана в <a href=https://staticman.net/docs/configuration>официальной документации</a>, нам нужно создать файл <code>staticman.yml</code>, полный пример заполнения можно найти <a href=https://github.com/eduardoboucas/staticman/blob/master/staticman.sample.yml>здесь</a>. Я же приведу сокращенный вариант, который настроен для <a href=https://github.com/xbreaker/xbreaker.github.io/blob/main/staticman.yml>этого сайта</a>:</p><script type=application/javascript src="https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1.js?file=staticman.yml"></script><p>Поля <code>thread</code>, <code>parentName</code>, <code>parent</code> используются для вложенных комментариев. Так же обратите внимание на настройки reCAPTCHA, если планируете ее использовать.</p><h3 id=настройки-в-configyml>Настройки в config.yml<a hidden class=anchor aria-hidden=true href=#настройки-в-configyml>#</a></h3><p>Здесь нам необходимо внести настройки Staticman, которые будут использоваться при отправке комментария - ссылку на API, плюс вариантивные настройки сервиса reCAPTCHA. Настройки вносятся в файл <code>config.eml</code>, у меня они расположены в params.staticman:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>params</span>:
	<span style=color:#f92672>comments</span>: <span style=color:#66d9ef>true</span>
  	<span style=color:#f92672>staticman</span>:
    	<span style=color:#f92672>api</span>: <span style=color:#ae81ff>https://app-name.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments</span>
    	<span style=color:#f92672>recaptcha</span>:
    		<span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
    		<span style=color:#f92672>sitekey</span>: <span style=color:#e6db74>&#39;recaptcha-sitekey&#39;</span>
    		<span style=color:#f92672>secret</span>: <span style=color:#e6db74>&#39;recaptcha-secret&#39;</span></code></pre></td></tr></table></div></div><p>Ссылка на API должна быть вида:</p><p><code>https://app-name.herokuapp.com/v2/entry/&lt;ваш github user>/&lt;ваш github репозиторий>/main/comments</code></p><p>Обратите внимание на бранч вашего репозитория, для старых репозиториев это <strong>master</strong>, для новых - <strong>main</strong>.</p><h3 id=шаблон-комментариев>Шаблон комментариев<a hidden class=anchor aria-hidden=true href=#шаблон-комментариев>#</a></h3><p>Самый объемный пункт, так как нам нужно подготовить шаблон для своей темы, не забыть про JS, а так же про стили оформления. На моём сайте используется тема <a href=https://github.com/adityatelange/hugo-PaperMod>PaperMod</a>, поэтому шаблон я буду делать для этой темы. Если вы используете другую тему, то адаптировать мой вариант будет не сложно.</p><p>Я не стал особо фантазировать, а решил использовать что-нибудь простое, интересный вариант нашелся <a href=https://css-tricks.com/styling-comment-threads/>здесь</a>. Он послужил основой нашего шаблона, который был доработан под нужды статичного сайта - добавлен аватар и удалена голосовалка, так как в условиях статики ее нам не реализовать. Сам шаблон состоит из нескольких файлов, первым будет <code>comments.html</code> - целиком я его приводить не буду, так как он слишком большой, найти его можно <a href=https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1#file-comments-html>🧾 здесь</a>, я же остановлюсь на паре моментов.</p><p>Склонение окончания числительных, перед комментариями выводится их количество и, в зависимости от числа комментариев, меняется окончание слова &ldquo;комментарий&rdquo;. В шаблоне сейчас это выглядит очень громоздко, если кто-то подскажет более изящный вариант - буду очень благодарен.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>  {{ $c := len $comments }}
  {{ if (and (eq (mod $c 10) 1) (ne (mod $c 100) 11)) }}
    &lt;<span style=color:#f92672>h3</span>&gt;{{ $c }} комментарий&lt;/<span style=color:#f92672>h3</span>&gt;
  {{ else }}
    {{ if (and (ge (mod $c 10) 2) (le (mod $c 10) 4) (or (lt (mod $c 100) 10) (ge (mod $c 100) 20))) }}
      &lt;<span style=color:#f92672>h3</span>&gt;{{ $c }} комментария&lt;/<span style=color:#f92672>h3</span>&gt; 
    {{ else }}
      &lt;<span style=color:#f92672>h3</span>&gt;{{ $c }} комментариев&lt;/<span style=color:#f92672>h3</span>&gt; 
    {{ end }}
  {{ end }}</code></pre></td></tr></table></div></div><p>Второй момент - это выделение комментариев автора блога от остальных. Чтобы это работало необходимо в параметры сайта внести параметр <code>emailhash</code>, который содержит md5 хэш вашего почтового адреса. Чтобы его получить, заходим, например, <a href=http://www.md5.cz/>сюда</a>, вводим свою электронную почту и получившийся результат вносим в параметры:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>params</span>:
	<span style=color:#f92672>emailhash</span>: <span style=color:#ae81ff>23463b99b62a72f26ed677cc556c44e8</span></code></pre></td></tr></table></div></div><p>Файл <code>comments.html</code> следует скопировать в каталог <code>\layouts\partials\</code>.</p><p>Второй файл - это файл стилей <code>comments.css</code>, чтобы он попал в общий файл CSS стилей, придется пойти на хитрость - создать каталог <code>assets\css\common\</code> и скопировать файл в данный каталог. Исходный код файла можно найти <a href=https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1#file-comments-css>🧾 здесь</a>.</p><p>Вместе с файлом стилей нам нужен файл javascript логики, который добавит интерактивности нашим комментариям и форме отправки - <code>comments.js</code>. Я использовал чистый JS (vanilla), чтобы исключить зависимость от какого-либо фреймворка. Интересный вариант отправки формы я взял <a href=https://stackoverflow.com/a/49060003>отсюда</a> и <a href=https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_forms_through_JavaScript#using_formdata_bound_to_a_form_element>отсюда</a>. Сам файл можно скопировать в каталог <code>assets\js\</code>, подключим мы его в следующем абзаце. Исходный код файла забираем <a href=https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1#file-comments-js>🧾 здесь</a>.</p><p>Чтобы подключить наш JS файл нам следует создать специальный файл темы <code>extend_head.html</code> он позволяет добавить в HEAD сайта свои инструкции, чем мы и воспользуемся - добавим загрузку и сжатие нашего <code>comments.js</code>. Кроме того, я добавил в него опциональную загрузку файла reCAPTCHA, если она включена в настройках. Копируем <a href=https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1#file-extend_head-html>🧾 содержимое</a> и копируем его в каталог <code>\layouts\partials\</code>.</p><p>Все файлы сразу расположены в этом <a href=https://gist.github.com/xbreaker/37c0fd11111e514e406038394b812bb1>💾 gist</a>, я специально не стал давать ссылки на репозиторий этого сайта, а выложил их отдельно. Так как в будущем файлы сайта могут измениться (или некоторые вообще могут быть удалены) и перестанут соответствовать тому, что здесь написано. А gist останется актуальным и нетронутым.</p><h3 id=настройка-и-включение-recaptcha>Настройка и включение reCAPTCHA<a hidden class=anchor aria-hidden=true href=#настройка-и-включение-recaptcha>#</a></h3><p>Выходим на финишную прямую, нам осталось подключить и настроить сервис reCAPTCHA. Данный сервис добавляет на сайт простой вариант проверки при отправке комментария и позволяет сильно снизить количество спам комментариев.</p><p>Для начала следует сходить на <a href=https://developers.google.com/recaptcha>официальный сайт</a> и <a href=https://www.google.com/recaptcha/admin/create>зарегистрироваться</a>. Нам нужна <code>reCAPTCHA v2 Checkbox</code> версия, выбираем ее при регистрации:</p><figure><img loading=lazy src=/img/posts/staticman_9.png alt="reCAPTCHA v2 Checkbox"><figcaption><p>reCAPTCHA v2 Checkbox</p></figcaption></figure><p>Получаем site key и secret key, которые будут использованы далее:</p><figure><img loading=lazy src=/img/posts/staticman_10.png alt="Наши секреты"><figcaption><p>Наши секреты</p></figcaption></figure><p>Если site key сразу можно внести в настройки сайта и Staticman, то secret key не предназначен, чтобы передаваать его в открытом виде. Поэтому его нужно зашифровать, поможет нам в этом наше ранее созданное приложение API.</p><p>Вызываем его по урлу вида:</p><p><code>https://app-name.herokuapp.com/v2/encrypt/secretKey</code></p><p>И результат, который оно возвратит и есть наш secret key для настроек. Сохраните обязательно где-нибудь оригинальный secret key на будущее.</p><p>Вносим настройки в <code>config.yml</code> и <code>staticman.yml</code>. Вот и все, готово 👍! Можно приступать к тестированию комментариев.</p><figure><img loading=lazy src=/img/posts/staticman_11.png alt=reCAPTCHA><figcaption><p>reCAPTCHA</p></figcaption></figure><h3 id=итого>Итого<a hidden class=anchor aria-hidden=true href=#итого>#</a></h3><p>В этом посте можно посмотреть результат реализации таких комментариев, создаваемые PR после отправки комментария можно найти в <a href=https://github.com/xbreaker/xbreaker.github.io/pulls>репозитории</a>.</p><blockquote><p>Если у вас есть что добавить или поправить в этой статье - можно вносить правки <a href=https://github.com/xbreaker/xbreaker.github.io/blob/main/content/posts/site/staticman-comments-for-github-pages.md>напрямую</a>.</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://aybe.org/tags/github/>github</a></li><li><a href=https://aybe.org/tags/github-pages/>github-pages</a></li><li><a href=https://aybe.org/tags/comments/>comments</a></li><li><a href=https://aybe.org/tags/howto/>howto</a></li><li><a href=https://aybe.org/tags/hugo/>hugo</a></li></ul><nav class=paginav><a class=prev href=https://aybe.org/2021/07/google-chrome-tab-sessions/><span class=title>« Предыдущая</span><br><span>Сохранение сессий вкладок в Google Chrome</span></a>
<a class=next href=https://aybe.org/2021/06/udm-dyndns-for-digitalocean/><span class=title>Следующая »</span><br><span>Использование Digital Ocean в качестве Dynamic DNS для UDM/UDM Pro</span></a></nav></footer><section id=comment-thread class="js-comments comment-thread"><h3>4 комментария</h3><details open class=comment id=comment-1 data-thread=8d86db70-e572-11eb-b989-f9b6a013036f data-id=8d86db70-e572-11eb-b989-f9b6a013036f data-name=Айрат><a href=#comment-1 class=comment-border-link><span class=sr-only>Перейти к первому комментарию</span></a>
<summary><div class=comment-heading><div class=comment-avatar><img src="https://www.gravatar.com/avatar/8ba9fb6714b8b017f86e5fcb2752c7a0?s=48&d=identicon" alt="Айрат's gravatar"></div><div class=comment-info><span class=comment-author>Айрат</span><p class=m-0><span class=comment-owner>автор • </span><time datetime=1626356573>15 Jul 2021 13:42:53</time></p></div></div></summary><div class=comment-body><p>Первый тестовый <strong>комментарий</strong> 👍</p><button data-toggle=reply-form>Ответить</button></div><div class=replies><details open class=comment id=comment-1r1 data-thread=8d86db70-e572-11eb-b989-f9b6a013036f data-id=333b5be0-e573-11eb-b989-f9b6a013036f data-name=Айрат><a href=#comment-1r1 class=comment-border-link><span class=sr-only>Перейти к первому комментарию</span>
</a><summary><div class=comment-heading><div class=comment-avatar><img src="https://www.gravatar.com/avatar/8ba9fb6714b8b017f86e5fcb2752c7a0?s=48&d=identicon" alt="Айрат's gravatar"></div><div class=comment-info><span class=comment-author>Айрат</span> ответил <a class=comment-author href=#comment-1 class=comment-reply-target title=8d86db70-e572-11eb-b989-f9b6a013036f>Айрат</a><p class=m-0><span class=comment-owner>автор</span> • <time datetime=1626356851>15 Jul 2021 13:47:31</time></p></div></div></summary><div class=comment-body><p>Первый тестовый ответ на первый тестовый комментарий 💪🏻🎉🎉🎉</p><button data-toggle=reply-form>Ответить</button></div></details></div></details><details open class=comment id=comment-2 data-thread=04c5c620-eb85-11eb-b673-abe168adef13 data-id=04c5c620-eb85-11eb-b673-abe168adef13 data-name=Максим><a href=#comment-2 class=comment-border-link><span class=sr-only>Перейти к первому комментарию</span></a>
<summary><div class=comment-heading><div class=comment-avatar><img src="https://www.gravatar.com/avatar/71523413e19bceff7647d992f4b44ff0?s=48&d=identicon" alt="Максим's gravatar"></div><div class=comment-info><span class=comment-author>Максим</span><p class=m-0><time datetime=1627024211>23 Jul 2021 07:10:11</time></p></div></div></summary><div class=comment-body><p>Очень круто получилось, есть еще вот такой вариант - <a href=https://utteranc.es/>utterances 🔮</a>
Его минус в том, что обязательна авторизация через гитхаб, но выглядит не хуже 😉</p><button data-toggle=reply-form>Ответить</button></div><div class=replies><details open class=comment id=comment-2r1 data-thread=04c5c620-eb85-11eb-b673-abe168adef13 data-id=ad1f6400-eb87-11eb-b673-abe168adef13 data-name=Айрат><a href=#comment-2r1 class=comment-border-link><span class=sr-only>Перейти к первому комментарию</span>
</a><summary><div class=comment-heading><div class=comment-avatar><img src="https://www.gravatar.com/avatar/8ba9fb6714b8b017f86e5fcb2752c7a0?s=48&d=identicon" alt="Айрат's gravatar"></div><div class=comment-info><span class=comment-author>Айрат</span> ответил <a class=comment-author href=#comment-2 class=comment-reply-target title=04c5c620-eb85-11eb-b673-abe168adef13>Максим</a><p class=m-0><span class=comment-owner>автор</span> • <time datetime=1627025352>23 Jul 2021 07:29:12</time></p></div></div></summary><div class=comment-body><p>Спасибо, посмотрел - прикольно. И спасибо за тестирование markdown в комментариях, <a href=https://github.com/xbreaker/xbreaker.github.io/commit/3d5d54a581d265e40a02d1cc34dc8568994be2f1>нашел</a> пару ошибок оформления в CSS.</p><button data-toggle=reply-form>Ответить</button></div></details></div></details><form id=reply-form class="js-form reply-form" method=post action=https://aybeorg.herokuapp.com/v2/entry/xbreaker/xbreaker.github.io/main/comments><h3 id=reply-form-head>Добавить комментарий</h3><div id=notice class=notice></div><input type=hidden name=options[slug] value=staticman-comments-for-github-pages>
<input type=hidden name=options[parent] value=https://aybe.org/2021/07/staticman-comments-for-github-pages/>
<input id=input-thread type=hidden name=fields[thread]>
<input id=input-parent type=hidden name=fields[parent]>
<input id=input-parentName type=hidden name=fields[parentName]>
<input type=hidden name=options[reCaptcha][siteKey] value=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ>
<input type=hidden name=options[reCaptcha][secret] value="w0e8kjpH56nyKZkvYX0Oe4kOTSOxu3c1rr2Cw4L67iB0Gx1MTBSemXn0pY+05X3Lezu/FEORlYMB15Mr9lZHSDhdpkee2l3dw3SMD7BAkJpAErtXqyC5PsSinCsZf0989VObxa/74QAp+NyF7Zr4lbY+equDeBPN9p/TqwSv0jn5Wdj2xJOoCfdThiAEeN+6DRXIqnnIMWZ6PPVkiYuBQb8zYvywNgaJ18ctucTKlnOI3SsVR8G4R86jtkvn/+cl9u+2Tu61yS1HPwz78/Aips9OdRFcLdsConD6QqbJV4R0lKFArqjD7smPKal3z/WqH1P4gED54NuNSI6VQt+Tu0J25qgEmZuL+3tJp+Jr1WyGCjrHdvatxa/dTDQgV2F+XLSLd/RmC9GbT3ukEB1CI/IFvznuj4iHtBNog7v7mwht4CVUGzIsaHNSkzMdjP/Tbt8K7YptjkhyUISuamDwbauXiTUlQishzwP8l3iM0CJRh3gKQGBP9u5svoctjCgzQzjgHfqHDgnKD2oyzSl4l4/UmwetxCEkvmY9h05VinAqMKu+wg1TTpKh0xJ0LW7TGoctfoupnzM+XTUy0UGxHBNdVFDVoP9xoQcZgkfw2yWm96t3K78kRMqWbiNqw0ZuJPy6x1IFeuPLh9CLhwflfkJW1j8UbG+WHzQLgJJUIkQ=">
<textarea name=fields[message] placeholder="Вы можете использовать синтаксис Markdown" rows=6 required></textarea>
<input name=fields[name] type=text placeholder=имя required>
<input type=email name=fields[email] placeholder=email required><div class=g-recaptcha data-sitekey=6LfuipkbAAAAAFmcmiZa7HYmEk40r0JJ-ua665vQ></div><button id=submit>Отправить</button>
<button id=cancel-button class=d-none data-toggle=reply-form-cancel>Отменить</button></form></section></article></main><footer class=footer><span>&copy; 2021 <a href=https://aybe.org/>Ayrat Belyaev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>